name: Sync Excel from Yandex.Disk

on:
  schedule:
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 8:00 –ø–æ –ú–æ—Å–∫–≤–µ
    - cron: '0 5 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Download file from Yandex.Disk
      run: |
        python -c "
import requests
import json
import os

# –ü—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–∞–ø–∫—É
folder_url = 'https://disk.360.yandex.ru/d/ZtwhX-YtLvkxJw'
target_file = 'report.xlsx'

# 1. –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞–ø–∫–µ
print('üìÅ –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–∞–ø–∫–µ...')
api_url = f'https://cloud-api.yandex.net/v1/disk/public/resources?public_key={folder_url}&limit=500'
response = requests.get(api_url)
response.raise_for_status()
data = response.json()

# 2. –ù–∞—Ö–æ–¥–∏–º —Ñ–∞–π–ª report.xlsx
print('üîç –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–∞...')
file_info = None
for item in data.get('_embedded', {}).get('items', []):
    if item.get('name') == target_file:
        file_info = item
        break

if not file_info:
    raise Exception(f'–§–∞–π–ª {target_file} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–∞–ø–∫–µ')

print(f'‚úÖ –§–∞–π–ª –Ω–∞–π–¥–µ–Ω: {file_info.get(\"name\")}')

# 3. –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
print('üîó –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è...')
download_url = f'https://cloud-api.yandex.net/v1/disk/public/resources/download?public_key={folder_url}&path={file_info[\"path\"]}'
download_response = requests.get(download_url)
download_response.raise_for_status()
download_data = download_response.json()
direct_url = download_data.get('href')

if not direct_url:
    raise Exception('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è')

# 4. –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
print('‚¨áÔ∏è –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞...')
file_response = requests.get(direct_url, stream=True)
file_response.raise_for_status()

# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
os.makedirs('data', exist_ok=True)
with open('data/report.xlsx', 'wb') as f:
    for chunk in file_response.iter_content(chunk_size=8192):
        f.write(chunk)

file_size = os.path.getsize('data/report.xlsx')
print(f'‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω: {file_size} –±–∞–π—Ç')

# 5. –°–æ–∑–¥–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
metadata = {
    'last_updated': '$(date -Iseconds)',
    'source_url': folder_url,
    'file_name': target_file,
    'file_size': file_size,
    'status': 'success'
}

with open('data/metadata.json', 'w', encoding='utf-8') as f:
    json.dump(metadata, f, ensure_ascii=False, indent=2)

print('üéâ –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!')
"
      env:
        DATE: $(date -Iseconds)

    - name: Check if file changed
      id: check
      run: |
        if git diff --name-only HEAD data/report.xlsx 2>/dev/null | grep -q "report.xlsx"; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "üìÑ –§–∞–π–ª –∏–∑–º–µ–Ω–∏–ª—Å—è"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "üìÑ –§–∞–π–ª –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è"
        fi

    - name: Commit and push changes
      if: steps.check.outputs.changed == 'true'
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        git add data/
        
        # –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        git commit -m "üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç $(date '+%Y-%m-%d %H:%M')"
        
        # –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        git push origin HEAD:${{ github.ref }}
        
        echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"

    - name: Upload to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: steps.check.outputs.changed == 'true'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        publish_branch: gh-pages
        keep_files: true
