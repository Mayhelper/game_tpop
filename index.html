<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAY GAMES</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <style>
        :root {
            --font-main: 'Oswald', sans-serif;
            --text-light: #FFFFFF;
            --btn-male: #0288D1;
            --btn-female: #D81B60;
            --color-neutral-icon: #b0b0b0;
            --active-tab-color: #7CB342; 
        }
        body {
            margin: 0; font-family: var(--font-main);
            min-height: 100vh; color: #2c3e50;
            transition: background-color 0.4s ease;
            background-color: #f0f2f5;
            overflow: hidden; text-transform: uppercase;
        }
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            padding: 20px; box-sizing: border-box;
            transition: opacity 0.5s ease, transform 0.5s ease;
            opacity: 0; transform: scale(0.95); pointer-events: none;
        }
        .screen.active { opacity: 1; transform: scale(1); pointer-events: auto; }
        #screen-gender, #screen-character-select { justify-content: center; }
        #screen-character-select .swiper-pagination { display: none !important; }
        
        /* --- ЭКРАН ЗАГРУЗКИ --- */
        #screen-loader {
            background-image: url('https://raw.githubusercontent.com/Mayhelper/game_tpop/main/images/loader-bg.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #667eea; /* Fallback цвет, если изображение не загрузится */
            justify-content: flex-end; /* Выравнивание внизу */
            align-items: center;
            z-index: 9999;
            padding-bottom: 0; /* Убираем отступ, чтобы кнопка была внизу */
        }
        /* Когда экран загрузки скрыт, он не должен перекрывать другие элементы */
        #screen-loader:not(.active) {
            z-index: -1;
        }
        #screen-loader.active {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }
        .loader-content {
            text-align: center;
            color: white;
            width: 90%;
            max-width: 350px;
            padding: 0 20px 20px 20px; /* Небольшой отступ только снизу для безопасности */
        }
        .loader-progress-container {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .loader-progress-bar {
            height: 100%;
            background: #E53935; /* Красный цвет */
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
            box-shadow: 0 0 10px rgba(229, 57, 53, 0.6);
        }
        .loader-progress-text {
            text-align: center;
            color: rgba(255, 255, 255, 0.95);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 16px;
            min-height: 20px;
        }
        .loader-start-button {
            width: 100%;
            padding: 16px;
            background: #E53935; /* Красный цвет */
            border: none;
            border-radius: 12px;
            color: white;
            font-family: var(--font-main);
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0;
            pointer-events: none;
            transform: translateY(10px);
            box-shadow: 0 4px 15px rgba(229, 57, 53, 0.4);
        }
        .loader-start-button.visible {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        .loader-start-button:hover {
            background: #C62828;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(229, 57, 53, 0.6);
        }
        .loader-start-button:active {
            transform: translateY(0);
        }

        h1 { text-align: center; margin-bottom: 30px; margin-top: 10px; font-weight: 700; }
        .brand-title {
            font-size: 20px; font-weight: 400; letter-spacing: 2px;
            opacity: 0.8; margin-bottom: 0;
        }
        /* --- ЭКРАН 1: Выбор пола --- */
        body.theme-male-selection, body.theme-female-selection { color: var(--text-light); }
        body.theme-male-selection { background-color: #4FC3F7; }
        body.theme-female-selection { background-color: #F06292; }
        .gender-selection-container { display: flex; gap: 20px; margin-bottom: 40px; }
        .gender-option {
            background: rgba(255, 255, 255, 0.9); color: #2c3e50;
            border-radius: 16px; padding: 20px; text-align: center; cursor: pointer;
            border: 3px solid transparent; transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 130px;
        }
        .gender-option .image-placeholder {
            width: 80px; height: 80px; margin: 0 auto 15px;
            display: flex; align-items: center; justify-content: center; 
            font-size: 42px; font-weight: 700; color: var(--color-neutral-icon);
            background-color: #e0e0e0; border-radius: 50%;
            transition: color 0.3s ease, background-color 0.3s ease;
        }
        .gender-option:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .gender-option.active-male { border-color: var(--btn-male); }
        .gender-option.active-male .image-placeholder { color: var(--btn-male); background-color: #e3f2fd; }
        .gender-option.active-female { border-color: var(--btn-female); }
        .gender-option.active-female .image-placeholder { color: var(--btn-female); background-color: #fce4ec; }
        /* --- Кнопки --- */
        .main-button {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 350px; padding: 16px; border: none; border-radius: 12px;
            font-family: var(--font-main); font-size: 18px; font-weight: 700;
            color: white; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase;
            z-index: 1000; /* Убеждаемся, что кнопка поверх экранов */
        }
        #btn-confirm-gender { 
            opacity: 0 !important; 
            pointer-events: none !important; 
            transform: translate(-50%, 20px) !important;
            z-index: 1000 !important; /* Убеждаемся, что кнопка поверх других элементов */
            display: block !important; /* Убеждаемся, что кнопка отображается */
        }
        #btn-confirm-gender.visible { 
            opacity: 1 !important; 
            pointer-events: auto !important; 
            transform: translateX(-50%) !important;
        }
        body.theme-male-selection #btn-confirm-gender { background-color: var(--btn-male); }
        body.theme-female-selection #btn-confirm-gender { background-color: var(--btn-female); }
        /* Скрываем кнопку "Далее" на экране выбора персонажа */
        body.character-selection-active #btn-confirm-gender {
            display: none !important;
            opacity: 0 !important;
            pointer-events: none !important;
            visibility: hidden !important;
        }
        /* --- ЭКРАН 2: Выбор персонажа --- */
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(25px); } to { opacity: 1; transform: translateY(0); }
        }
        .character-info {
            width: 100%; text-align: center; padding: 0 20px; box-sizing: border-box;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4); opacity: 0;
        }
        .character-info.animate-in { opacity: 1; animation: slideInUp 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        #character-title { font-size: 32px; font-weight: 700; min-height: 40px; margin-bottom: 5px; }
        #character-description { font-size: 16px; font-weight: 400; min-height: 40px; margin-top: 5px; letter-spacing: 0.5px; }
        .swiper { width: 100%; height: 60%; max-height: 450px; }
        .swiper-slide img { display: block; width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 10px 25px rgba(0,0,0,0.3)); }
        #btn-confirm-character { background-color: #43A047; }

        /* --- СТИЛИ: ЭКРАН 3 - Геймификация --- */
        #screen-gamification { 
            padding: 0; 
            /* Фон устанавливается через JavaScript из GitHub */
            background-size: cover;
            background-position: center;
            background-color: #1a2639; /* Резервный цвет, если картинка не загрузится */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        .game-top-area {
            position: relative;
            width: 100%;
            height: 33vh;
            min-height: 200px;
            max-height: 280px;
            flex-shrink: 0;
            overflow: hidden;
        }
        .game-character-display {
            position: absolute; 
            top: 60%; /* Опускаем персонажа ниже */
            left: 50%;
            transform: translate(-50%, -50%); /* Центрирование по вертикали и горизонтали */
            text-align: center; 
            width: 160px; /* Увеличен размер персонажа */
            height: 230px; /* Увеличен размер персонажа */
            z-index: 2; /* Персонаж поверх других элементов */
        }
        .game-character-display img {
            width: 160px; /* Увеличен размер персонажа */
            height: 230px; /* Увеличен размер персонажа */
            object-fit: contain; /* Сохраняет пропорции */
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
        }
        .game-character-display h2 {
            display: none; /* Скрываем подпись под персонажем */
        }
        .game-side-panel {
            position: absolute; 
            top: 20px;
            bottom: 20px;
            width: 30%;
            max-width: 110px; 
            min-width: 0;
            display: flex;
            flex-direction: column; 
            gap: 8px;
            z-index: 1;
            box-sizing: border-box;
        }
        .game-side-panel > *:last-child { margin-top: auto; }
        #status-xp { margin-top: auto; margin-bottom: auto; }
        .panel-left { left: 10px; }
        .panel-right { right: 10px; }
        .status-bar {
            background: rgba(0, 0, 0, 0.78);
            border-radius: 10px;
            padding: 6px 8px; 
            color: white; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            font-size: 10px;
            border: 1px solid rgba(0, 0, 0, 0.9);
            box-sizing: border-box;
        }
        .status-bar label {
            font-size: 11px; opacity: 0.95; display: flex;
            justify-content: space-between; align-items: center;
            font-weight: 400; margin-bottom: 4px;
        }
        .status-bar label span {
            font-size: 10px; font-weight: 700; background: rgba(0,0,0,0.4);
            padding: 2px 4px; border-radius: 4px;
        }
        #status-health, #status-xp, #status-gold { cursor: pointer; }
        #status-health .bar-content { font-size: 16px; letter-spacing: 1px; }
        #status-health .bar-content span { color: #E53935; text-shadow: 0 0 5px rgba(255, 82, 82, 0.7); }
        #status-health .bar-content span.heart-empty { color: rgba(255,255,255,0.35); }
        .progress-bar-container {
            background-color: rgba(0, 0, 0, 0.3); border-radius: 5px;
            height: 10px; overflow: hidden; width: 100%;
        }
        .progress-bar-fill { background-color: #7CB342; height: 100%; border-radius: 5px; }
        #status-gold .bar-content { font-size: 13px; font-weight: 700; color: #FFEB3B; }
        .shop-button {
            width: 100%;
            padding: 10px 8px;
            background-color: rgba(0, 0, 0, 0.75);
            border-radius: 10px;
            border: 1px solid rgba(0, 0, 0, 0.9);
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            font-family: var(--font-main);
            font-size: 13px;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }
        .shop-button-icon { margin-right: 6px; font-size: 1.1em; }
        .shop-button:hover {
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.02);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            background-color: rgba(0, 0, 0, 0.85);
        }
        .shop-button:active {
            transform: scale(0.98);
        }
        .clothing-slots { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .clothing-slot {
            width: 100%; 
            padding-top: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            border-radius: 10px;
            border: 1px solid rgba(0, 0, 0, 0.9);
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
        }
        .clothing-slot:hover {
            border-color: rgba(255, 255, 255, 0.4);
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .clothing-slot img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center center;
            padding: 0;
            box-sizing: border-box;
        }
        .bonus-set-button {
            width: 100%;
            margin-top: 8px;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.75);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 12px;
            font-weight: 700;
            line-height: 1.3;
            color: rgba(255, 255, 255, 0.95);
            text-transform: uppercase;
            cursor: pointer;
            box-sizing: border-box;
            transition: background 0.2s, border-color 0.2s;
        }
        .bonus-set-button { display: flex; align-items: center; justify-content: center; gap: 6px; }
        .bonus-set-button-icon { font-size: 1.15em; }
        .bonus-set-button:hover {
            background: rgba(0, 0, 0, 0.85);
            border-color: rgba(255, 255, 255, 0.35);
        }
        .clothing-slot-icon {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 0;
            font-size: 28px; /* Немного увеличиваем размер */
            opacity: 0.9; /* Увеличиваем непрозрачность для лучшей видимости */
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); /* Добавляем тень для контраста */
        }
        
        /* Модальное окно правил жизней */
        .health-rules-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.75);
            z-index: 1000;
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .health-rules-modal.active { display: flex; }
        .health-rules-modal-content {
            background: rgba(20, 30, 48, 0.98);
            border-radius: 16px;
            padding: 24px;
            max-width: 340px;
            width: 100%;
            border: 1px solid rgba(0, 0, 0, 0.9);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .health-rules-modal h3 {
            margin: 0 0 16px 0;
            font-size: 18px;
            color: white;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .health-rules-modal h3 .info-modal-title-icon { color: #E53935; }
        .health-rules-modal p {
            margin: 0 0 12px 0;
            font-size: 14px;
            line-height: 1.5;
            color: rgba(255,255,255,0.9);
            text-transform: none;
        }
        .health-rules-modal-close {
            margin-top: 16px;
            width: 100%;
            padding: 12px;
            background: rgba(124, 179, 66, 0.8);
            border: 1px solid rgba(124, 179, 66, 0.9);
            border-radius: 10px;
            color: white;
            font-family: var(--font-main);
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
        }
        .info-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); z-index: 1000; backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .info-modal.active { display: flex; }
        .info-modal-content { background: rgba(20, 30, 48, 0.98); border-radius: 16px; padding: 24px; max-width: 340px; width: 100%; max-height: 80vh; overflow-y: auto; border: 1px solid rgba(0,0,0,0.9); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .info-modal h3 { margin: 0 0 16px 0; font-size: 18px; color: white; text-transform: uppercase; }
        .info-modal-title-with-icon { display: flex; align-items: center; gap: 8px; }
        .info-modal-title-icon { font-size: 1em; line-height: 1; vertical-align: middle; }
        .xp-sources-list .xp-source-cards { color: #4FC3F7; }
        .xp-sources-list .xp-source-quests { color: #7CB342; }
        .xp-sources-list .xp-source-achievements { color: #F06292; }
        .xp-sources-list .xp-source-daily { color: #FFB74D; }
        .xp-sources-list .xp-source-outfit { color: #BA68C8; }
        .xp-sources-list .xp-amount { color: #B39DDB; font-weight: 700; }
        .info-modal p, .info-modal li { margin: 0 0 10px 0; font-size: 14px; line-height: 1.5; color: rgba(255,255,255,0.9); text-transform: none; }
        .info-modal ul { margin: 0 0 12px 0; padding-left: 20px; }
        .info-modal-close { margin-top: 16px; width: 100%; padding: 12px; background: rgba(124, 179, 66, 0.8); border: 1px solid rgba(124, 179, 66, 0.9); border-radius: 10px; color: white; font-family: var(--font-main); font-size: 14px; font-weight: 700; text-transform: uppercase; cursor: pointer; }
        .gold-history-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 13px; }
        .gold-history-item:last-child { border-bottom: none; }
        .gold-history-reason { color: #98D4BB; }
        .gold-history-amount { color: #FFEB3B; font-weight: 700; }
        .gold-history-date { font-size: 11px; opacity: 0.7; margin-top: 2px; }
        
        /* Модальное окно выбора одежды */
        .clothing-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .clothing-modal.active {
            display: flex;
            flex-direction: column;
        }
        .clothing-modal-content {
            width: 100%;
            height: 100%;
            background: rgba(20, 30, 48, 0.95);
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            position: relative;
        }
        .clothing-modal-header {
            display: none;
        }
        .clothing-modal-close {
            display: none;
        }
        .clothing-modal-close-top {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(240, 98, 146, 0.8);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            font-size: 22px;
            font-weight: 300;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .clothing-modal-close-top:hover {
            background: rgba(240, 98, 146, 1);
            transform: scale(1.05);
        }
        .clothing-modal-close-top:active {
            transform: scale(0.95);
        }
        .clothing-modal-type-tabs {
            display: none;
        }
        .clothing-type-tab {
            flex: 1;
            padding: 10px 8px;
            border: 1px solid rgba(255, 255, 255, 0.35);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.25);
            color: rgba(255, 255, 255, 0.9);
            font-family: var(--font-main);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .clothing-type-tab:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.5);
        }
        .clothing-type-tab.active {
            background: rgba(79, 195, 247, 0.35);
            border-color: rgba(79, 195, 247, 0.7);
            color: white;
        }
        .clothing-modal-body {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            gap: 0;
            padding-top: 60px;
        }
        .clothing-preview-label {
            display: none;
        }
        .clothing-section {
            margin-bottom: 20px;
        }
        .clothing-section:last-child {
            margin-bottom: 0;
        }
        .clothing-section-title {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            padding: 0 4px;
        }
        .clothing-section-title-green {
            color: #81C784;
        }
        .clothing-section-title-purple {
            color: #BA68C8;
        }
        .clothing-section-title-blue {
            color: #64B5F6;
        }
        .clothing-preview-top {
            flex: 0 0 auto;
            display: flex;
            flex-direction: row;
            align-items: stretch;
            gap: 14px;
            padding: 12px;
            color: white;
            box-sizing: border-box;
            background: rgba(0, 0, 0, 0.28);
            border-radius: 14px;
            margin: 0;
        }
        .clothing-preview-icon {
            flex: 0 0 auto;
            align-self: center;
            width: clamp(100px, 26vmin, 140px);
            height: clamp(100px, 26vmin, 140px);
            min-width: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            overflow: hidden;
        }
        .clothing-preview-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            object-position: center center;
        }
        .clothing-preview-placeholder {
            font-size: 12px;
            opacity: 0.5;
            text-align: center;
            padding: 10px;
        }
        .clothing-preview-info {
            flex: 1;
            min-width: 0;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 6px;
            justify-content: flex-start;
            padding-bottom: 8px;
        }
        .clothing-preview-info .clothing-preview-name {
            font-size: 14px;
            font-weight: 700;
            margin: 0;
            text-align: left;
            line-height: 1.2;
        }
        .clothing-preview-info .clothing-preview-description {
            font-size: 11px;
            margin: 0;
            text-align: left;
            opacity: 0.9;
            line-height: 1.3;
            flex: 0 0 auto;
            max-height: 2.6em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            font-style: italic;
        }
        .clothing-how-to-get {
            margin-top: 10px;
            padding: 8px 10px;
            background: rgba(129, 212, 250, 0.22);
            border: 1px solid rgba(129, 212, 250, 0.4);
            border-radius: 10px;
            font-size: 11px;
            line-height: 1.35;
            text-transform: none;
            flex-shrink: 0;
        }
        .clothing-how-to-get-title {
            font-weight: 700;
            margin-bottom: 2px;
            opacity: 0.95;
        }
        .clothing-how-to-get-text {
            opacity: 0.9;
        }
        .clothing-set-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 0;
            flex-wrap: wrap;
            padding: 12px;
            background: rgba(0, 0, 0, 0.28);
            border-radius: 14px;
        }
        .clothing-set-info {
            flex: 1;
            min-width: 0;
        }
        .clothing-set-name {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: rgba(255, 255, 255, 0.85);
            margin-bottom: 6px;
        }
        .clothing-set-icons {
            display: flex;
            gap: 6px;
        }
        .clothing-set-slot {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.25);
            background: rgba(255, 255, 255, 0.08);
            transition: box-shadow 0.2s ease, border-color 0.2s ease;
        }
        .clothing-set-slot.has-item {
            border-color: rgba(76, 175, 80, 0.9);
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
        .clothing-set-slot.missing-item {
            border-color: rgba(244, 67, 54, 0.6);
            box-shadow: 0 0 8px rgba(244, 67, 54, 0.3);
        }
        .clothing-set-slot .clothing-set-slot-img {
            width: 100%;
            height: 100%;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }
        .clothing-set-slot .clothing-set-slot-img img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }
        .clothing-set-row .clothing-wear-set-button {
            flex: 0 0 auto;
            margin-top: 0;
            min-width: 90px;
        }
        .clothing-preview-actions {
            display: flex;
            flex-direction: row;
            gap: 14px;
            margin-top: 14px;
            flex-shrink: 0;
        }
        .clothing-preview-actions .clothing-select-button,
        .clothing-preview-actions .clothing-remove-button {
            flex: 1;
            margin-top: 0;
            padding: 8px 6px;
            font-size: 11px;
        }
        .clothing-grid-wrap {
            flex: 1 1 auto;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 14px;
            padding: 12px;
            box-sizing: border-box;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.25) transparent;
        }
        .clothing-grid-wrap::-webkit-scrollbar {
            width: 6px;
        }
        .clothing-grid-wrap::-webkit-scrollbar-track {
            background: transparent;
        }
        .clothing-grid-wrap::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.25);
            border-radius: 3px;
        }
        .clothing-items-grid {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding-bottom: 4px;
            box-sizing: border-box;
        }
        .clothing-item {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
        }
        .clothing-item:hover:not(.locked) {
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }
        .clothing-item.active {
            border-color: #4FC3F7;
            box-shadow: 0 0 15px rgba(79, 195, 247, 0.5);
        }
        .clothing-item.locked {
            cursor: not-allowed;
            background: rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.15);
        }
        .clothing-item.locked::after {
            content: 'закрыто';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .clothing-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center center;
            display: block;
            border-radius: 10px;
        }
        .clothing-select-button {
            width: 100%;
            padding: 14px;
            background: #4FC3F7;
            border: none;
            border-radius: 12px;
            color: white;
            font-family: var(--font-main);
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .clothing-select-button:hover {
            background: #29B6F6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 195, 247, 0.4);
        }
        .clothing-select-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .clothing-wear-set-button {
            width: 100%;
            padding: 12px;
            background: rgba(124, 179, 66, 0.8);
            border: 1px solid rgba(124, 179, 66, 0.9);
            border-radius: 12px;
            color: white;
            font-family: var(--font-main);
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        .clothing-wear-set-button:hover:not(:disabled) {
            background: rgba(124, 179, 66, 1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(124, 179, 66, 0.4);
        }
        .clothing-wear-set-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .clothing-remove-button {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            color: white;
            font-family: var(--font-main);
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        .clothing-remove-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        .clothing-remove-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        /* Модальное окно просмотра карточки */
        .card-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            backdrop-filter: blur(5px);
            touch-action: none;
            overflow: hidden;
        }
        .card-modal.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .card-modal-content {
            width: 90%;
            max-width: 400px;
            background: rgba(20, 30, 48, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-sizing: border-box;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .card-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .card-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .card-3d-container {
            width: 100%;
            max-width: 300px;
            aspect-ratio: 3/4;
            margin: 20px 0;
            perspective: 1000px;
        }
        .card-3d {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.3s ease;
            cursor: grab;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }
        .card-3d.card-3d-dragging {
            transition: none;
        }
        .card-3d:active {
            cursor: grabbing;
        }
        .card-3d-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        /* Лёгкая тень с противоположной от света стороны — усиливает ощущение направленного света при повороте */
        .card-3d-face-front::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            pointer-events: none;
            mix-blend-mode: multiply;
            opacity: var(--shadow-strength, 0);
            background: linear-gradient(
                135deg,
                transparent 0%,
                transparent 45%,
                rgba(0, 0, 0, 0.4) 100%
            );
            transition: opacity 0.25s ease;
        }
        /* Глянцевый блик — всегда виден (статичный + смещается при повороте) */
        .card-3d-face::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            pointer-events: none;
            mix-blend-mode: overlay;
            background: 
                radial-gradient(
                    circle at var(--gloss-x, 50%) var(--gloss-y, 50%),
                    rgba(255, 255, 255, 0.4) 0%,
                    rgba(255, 255, 255, 0.16) 18%,
                    rgba(255, 255, 255, 0.05) 38%,
                    transparent 55%
                ),
                radial-gradient(
                    circle at 28% 28%,
                    rgba(255, 255, 255, 0.25) 0%,
                    rgba(255, 255, 255, 0.08) 25%,
                    transparent 50%
                );
            transition: background 0.2s ease;
        }
        
        .card-3d-face img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 15px;
        }
        .card-3d-face-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, #1a2639 0%, #2d3e50 50%, #1a2639 100%);
            border: 2px solid rgba(255, 255, 255, 0.25);
            box-shadow: inset 0 0 30px rgba(0,0,0,0.4), 0 8px 20px rgba(0,0,0,0.3);
        }
        .card-3d-face-back::before {
            content: 'MAY GAMES';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 4px;
            color: rgba(255, 255, 255, 0.5);
            text-align: center;
        }
        .card-rotation-controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        .card-rotation-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 8px;
            color: white;
            font-family: var(--font-main);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .card-rotation-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .card-modal-name {
            font-size: 20px;
            font-weight: 700;
            color: white;
            margin-bottom: 10px;
            text-align: center;
        }
        .card-modal-description {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
            line-height: 1.5;
            text-transform: none;
        }
        
        /* Уведомление о новых картах — стиль iOS (frosted glass) */
        .notification {
            position: fixed;
            top: 16px;
            left: 12px;
            right: 12px;
            width: calc(100% - 24px);
            max-width: none;
            min-height: 56px;
            background: rgba(33, 150, 243, 0.85);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border: 2px solid rgba(33, 150, 243, 1);
            color: white;
            padding: 14px 16px 14px 18px;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(33, 150, 243, 0.4), 0 0 1px rgba(255, 255, 255, 0.3) inset;
            z-index: 3000;
            font-family: var(--font-main);
            font-size: 15px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            box-sizing: border-box;
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            animation: notificationSlideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .notification.active {
            display: flex;
        }
        .notification.notification-dismissing {
            transform: translateY(-120%);
            opacity: 0;
        }
        .notification-body {
            flex: 1;
            cursor: pointer;
        }
        .notification-cards-word {
            color: #1565C0;
            font-weight: 700;
        }
        .notification-close {
            flex-shrink: 0;
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.08);
            color: #333;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            transition: background 0.2s ease;
        }
        .notification-close:hover {
            background: rgba(0, 0, 0, 0.14);
        }
        .notification-close:active {
            background: rgba(0, 0, 0, 0.2);
        }
        @keyframes notificationSlideDown {
            from {
                opacity: 0;
                transform: translateY(-24px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* --- ИСПРАВЛЕННЫЙ БЛОК ВКЛАДОК --- */
        #tabs-container {
            position: relative;
            width: 100%;
            flex: 1;
            min-height: 0;
            background: rgba(20, 30, 48, 0.85);
            backdrop-filter: blur(10px);
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
            padding: 20px 15px 15px 15px;
            padding-top: 30px;
            box-sizing: border-box;
            color: white;
            display: none;
            box-shadow: 0 -10px 25px rgba(0,0,0,0.5);
            overflow: hidden;
            margin-top: 16px;
        }
        .tab-buttons {
            display: flex; gap: 5px; background: rgba(0, 0, 0, 0.25);
            border-radius: 14px; padding: 5px; box-sizing: border-box;
            margin-bottom: 8px;
        }
        .tab-button {
            flex: 1; background: none; border: none;
            color: rgba(255, 255, 255, 0.7); font-family: var(--font-main);
            font-size: 16px; text-transform: uppercase; padding: 10px 0;
            cursor: pointer; border-radius: 10px; transition: all 0.3s ease;
        }
        .tab-button.active {
            color: white; font-weight: 700;
            background-color: var(--active-tab-color);
        }
        .tabs-content { 
            height: calc(100% - 70px); /* Увеличено для большего пространства */
            min-height: 0; /* Позволяет контенту правильно сжиматься */
            overflow: hidden;
            padding-top: 2px; /* Небольшой отступ сверху */
        }
        .tab-pane {
            display: none; height: 100%;
            align-items: center; justify-content: center;
        }
        .tab-pane.active { display: flex; }
        .tab-pane#tab-quests { flex-direction: column; align-items: stretch; }
        .quest-sub-tabs {
            display: flex; gap: 6px; margin-bottom: 12px;
            background: rgba(0, 0, 0, 0.2); border-radius: 10px; padding: 5px;
        }
        .quest-sub-tab {
            flex: 1; padding: 8px 6px; border: none; border-radius: 8px;
            background: transparent; color: rgba(255, 255, 255, 0.7);
            font-family: var(--font-main); font-size: 12px; text-transform: uppercase;
            cursor: pointer; transition: all 0.2s ease;
        }
        .quest-sub-tab:hover { color: rgba(255, 255, 255, 0.9); }
        .quest-sub-tab.active {
            background: rgba(124, 179, 66, 0.5); color: white; font-weight: 700;
        }
        .quest-list-container { flex: 1; min-height: 0; overflow: hidden; display: flex; flex-direction: column; }
        .quest-list {
            display: none; list-style: none; margin: 0; padding: 8px 0;
            overflow-y: auto; -webkit-overflow-scrolling: touch; flex: 1;
            scrollbar-width: none; /* Firefox: скрыть полосу прокрутки */
            -ms-overflow-style: none; /* IE/Edge */
        }
        .quest-list::-webkit-scrollbar { display: none; } /* Chrome/Safari: скрыть полосу прокрутки */
        .quest-list.active { display: block; }
        .quest-item {
            padding: 12px 14px; margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.35); border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.95); font-size: 14px;
            cursor: pointer; transition: background 0.2s, border-color 0.2s;
        }
        .quest-item:hover {
            background: rgba(0, 0, 0, 0.5); border-color: rgba(255, 255, 255, 0.25);
        }
        .quest-item-title { font-weight: 700; margin-bottom: 4px; }
        .quest-item-reward { font-size: 12px; opacity: 0.95; }
        .quest-item-reward .reward-exp { color: #B39DDB; }
        .quest-item-reward .reward-coins { color: #D4C46A; }
        .quest-item-status { font-size: 11px; text-transform: uppercase; margin-top: 4px; }
        .quest-item.completed { border-color: rgba(76, 175, 80, 0.5); background: rgba(76, 175, 80, 0.15); }
        .quest-item.completed .quest-item-status { color: #81C784; }
        .quest-item.in-progress .quest-item-status { color: #E57373; }
        .quest-modal-reward { margin-top: 12px; font-size: 13px; font-weight: 600; }
        .quest-modal-reward .reward-exp { color: #B39DDB; }
        .quest-modal-reward .reward-coins { color: #D4C46A; }
        /* Адаптивная сетка карточек - показывает только реальные карты */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            width: 100%;
            height: 100%;
            padding: 10px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .card-item {
            aspect-ratio: 3/4;
            background: 
                linear-gradient(135deg, rgba(245, 245, 220, 0.15) 0%, rgba(250, 240, 230, 0.1) 100%),
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 0, 0, 0.03) 2px,
                    rgba(0, 0, 0, 0.03) 4px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 0, 0, 0.03) 2px,
                    rgba(0, 0, 0, 0.03) 4px
                ),
                radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.05) 0%, transparent 50%);
            background-color: rgba(245, 245, 220, 0.2);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            border: 2px solid rgba(139, 120, 100, 0.3);
            box-shadow: 
                0 2px 8px rgba(0,0,0,0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
        }
        .card-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 30% 40%, rgba(255, 255, 255, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 70% 60%, rgba(255, 255, 255, 0.05) 0%, transparent 40%);
            pointer-events: none;
            opacity: 0.6;
        }
        .card-item:hover {
            transform: scale(1.05);
            border-color: rgba(139, 120, 100, 0.5);
            box-shadow: 
                0 4px 12px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                inset 0 -1px 0 rgba(0, 0, 0, 0.15);
        }
        .card-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center center;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            border-radius: 10px;
        }
        .card-item-name {
            font-size: 11px;
            font-weight: 700;
            text-align: center;
            color: white;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 2;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.6) 70%, transparent 100%);
            padding: 8px 6px 6px 6px;
            width: 100%;
            box-sizing: border-box;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        /* Единый плейсхолдер при ошибке загрузки изображения */
        .no-image-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            font-size: 11px;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
            padding: 8px;
            box-sizing: border-box;
            text-transform: none;
        }
        
        .badges-swiper { 
            width: 100%; 
            height: 100%; 
            padding: 5px 0;
        }
        .badges-swiper .swiper-slide {
            background: rgba(255, 255, 255, 0.1); 
            border-radius: 12px;
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 14px; 
            font-weight: bold;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .badges-swiper .swiper-slide {
            height: 80px; /* Фиксированная высота для значков */
            aspect-ratio: 1; /* Квадратные значки */
            font-size: 32px; /* Увеличенный размер эмодзи */
        }
        #achievements-list {
            list-style: none; 
            padding: 0 5px; 
            margin: 0; 
            width: 100%;
            font-size: 14px; 
            text-transform: none; 
            text-align: left;
            height: 100%; 
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* Плавная прокрутка на iOS */
        }
        #achievements-list li { padding: 8px 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        #achievements-list li:last-child { border-bottom: none; }
        
        /* Медиа-запросы для маленьких экранов */
        @media (max-height: 600px) {
            .game-top-area {
                height: 35vh; /* Немного больше для маленьких экранов */
                min-height: 180px;
            }
            /* Персонаж остается фиксированного размера */
            .status-bar {
                padding: 6px;
                font-size: 10px;
            }
            .cards-swiper .swiper-slide {
                height: 90px; /* Немного меньше на маленьких экранах */
            }
            .badges-swiper .swiper-slide {
                height: 70px;
            }
        }
        
        @media (max-width: 360px) {
            .game-side-panel {
                max-width: 90px; /* Уменьшаем панели на очень маленьких экранах */
            }
            /* Персонаж остается фиксированного размера */
            .cards-swiper .swiper-slide {
                height: 85px;
                font-size: 12px;
            }
            .badges-swiper .swiper-slide {
                height: 65px;
                font-size: 28px;
            }
        }
    </style>
</head>
<body>

    <!-- ЭКРАН ЗАГРУЗКИ -->
    <div id="screen-loader" class="screen active">
        <div class="loader-content">
            <div class="loader-progress-container">
                <div class="loader-progress-bar" id="loader-progress-bar"></div>
            </div>
            <div class="loader-progress-text" id="loader-progress-text">0%</div>
            <button class="loader-start-button" id="loader-start-button" onclick="startGame()">Начать</button>
        </div>
    </div>

    <div id="screen-gender" class="screen">
        <!-- ... (содержимое без изменений) ... -->
        <h2 class="brand-title">MAY GAMES</h2>
        <h1>СДЕЛАЙ ВЫБОР</h1>
        <div class="gender-selection-container">
            <div class="gender-option" id="btn-male" onclick="selectGender('male')">
                <div class="image-placeholder">♂</div><h3>МУЖЧИНА</h3>
            </div>
            <div class="gender-option" id="btn-female" onclick="selectGender('female')">
                <div class="image-placeholder">♀</div><h3>ЖЕНЩИНА</h3>
            </div>
        </div>
    </div>

    <div id="screen-character-select" class="screen">
        <div id="character-title" class="character-info"></div>
        <div class="swiper">
            <div class="swiper-wrapper" id="character-swiper-wrapper"></div>
            <div class="swiper-pagination"></div>
        </div>
        <div id="character-description" class="character-info"></div>
    </div>

    <div id="screen-gamification" class="screen">
        <div class="game-top-area">
            <div class="game-character-display">
                <img id="game-character-image" src="" alt="Character">
            </div>
            <div class="game-side-panel panel-left">
                <!-- ... (статус-бары) ... -->
                 <div class="status-bar" id="status-health" onclick="openHealthRulesModal()" title="Правила жизней">
                    <label>жизни</label>
                    <div class="bar-content"><span>❤</span><span>❤</span><span class="heart-empty">🤍</span></div>
                </div>
                <div class="status-bar" id="status-xp" onclick="openXpModal()" title="За что даётся опыт">
                    <label>опыт <span>Level 5</span></label>
                    <div class="bar-content"><div class="progress-bar-container"><div class="progress-bar-fill" style="width: 60%;"></div></div></div>
                </div>
                <div class="status-bar" id="status-gold" onclick="openGoldModal()" title="История Май коины">
                    <label>МАЙ КОИНЫ</label>
                    <div class="bar-content">🪙 1250</div>
                </div>
            </div>
            <div class="game-side-panel panel-right">
                <button class="shop-button" onclick="openShop()"><span class="shop-button-icon">🎁</span> МАГАЗИН</button>
                <div class="clothing-slots">
                    <div class="clothing-slot" data-slot-type="head" onclick="openClothingModal('head')">
                        <div class="clothing-slot-icon">👤</div>
                    </div>
                    <div class="clothing-slot" data-slot-type="body" onclick="openClothingModal('body')">
                        <div class="clothing-slot-icon">👕</div>
                    </div>
                    <div class="clothing-slot" data-slot-type="legs" onclick="openClothingModal('legs')">
                        <div class="clothing-slot-icon">👖</div>
                    </div>
                    <div class="clothing-slot" data-slot-type="shoes" onclick="openClothingModal('shoes')">
                        <div class="clothing-slot-icon">👟</div>
                    </div>
                </div>
                <button type="button" class="bonus-set-button" id="bonus-set-button" onclick="openSetBonusModal()" title="Подробнее о бонусе набора"><span class="bonus-set-button-icon">⭐</span> Бонус набора</button>
            </div>
        </div>
        
        <div id="tabs-container">
            <div class="tab-buttons">
                <button class="tab-button active" data-color="#7CB342" onclick="switchTab('quests', this)">Задания</button>
                <button class="tab-button" id="tab-btn-cards" data-color="#4FC3F7" onclick="switchTab('cards', this)">Карточки</button>
                <button class="tab-button" data-color="#F06292" onclick="switchTab('achievements', this)">Достижения</button>
            </div>
            <div class="tabs-content">
                <div id="tab-quests" class="tab-pane active">
                    <div class="quest-sub-tabs">
                        <button type="button" class="quest-sub-tab active" data-quest-category="daily" onclick="switchQuestSubTab('daily', this)">Ежедневные</button>
                        <button type="button" class="quest-sub-tab" data-quest-category="monthly" onclick="switchQuestSubTab('monthly', this)">На месяц</button>
                        <button type="button" class="quest-sub-tab" data-quest-category="additional" onclick="switchQuestSubTab('additional', this)">Дополнительные</button>
                    </div>
                    <div class="quest-list-container">
                        <ul id="quest-list-daily" class="quest-list active"></ul>
                        <ul id="quest-list-monthly" class="quest-list"></ul>
                        <ul id="quest-list-additional" class="quest-list"></ul>
                    </div>
                </div>
                <div id="tab-cards" class="tab-pane">
                    <div class="cards-grid" id="cards-grid"></div>
                </div>
                <div id="tab-achievements" class="tab-pane">
                    <ul id="achievements-list"></ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно правил жизней -->
    <div id="health-rules-modal" class="health-rules-modal" onclick="if(event.target===this) closeHealthRulesModal()">
        <div class="health-rules-modal-content">
            <h3><span class="info-modal-title-icon">❤</span> Правила жизней</h3>
            <p>Если сотрудник не заходит в игру в течение <strong>2 дней</strong>, жизни теряются (одно сердце в день).</p>
            <p>При отсутствии жизней каждый день списываются <strong>Май коины</strong> в размере <strong>200 Май коинов</strong>.</p>
            <button type="button" class="health-rules-modal-close" onclick="closeHealthRulesModal()">Понятно</button>
        </div>
    </div>
    
    <!-- Модальное окно опыта -->
    <div id="xp-modal" class="info-modal" onclick="if(event.target===this) closeXpModal()">
        <div class="info-modal-content">
            <h3 class="info-modal-title-with-icon"><span class="info-modal-title-icon">⭐</span> За что даётся опыт</h3>
            <p>Опыт повышает ваш уровень и открывает новые возможности. Очки опыта начисляются за:</p>
            <ul class="xp-sources-list">
                <li><strong class="xp-source-cards">Карточки</strong> — за каждую новую открытую карточку <span class="xp-amount">+10 опыта</span></li>
                <li><strong class="xp-source-quests">Задания</strong> — за каждое выполненное задание <span class="xp-amount">+5 опыта</span></li>
                <li><strong class="xp-source-achievements">Достижения</strong> — за выполнение достижений <span class="xp-amount">+15–50 опыта</span> в зависимости от сложности</li>
                <li><strong class="xp-source-daily">Ежедневный вход</strong> — за вход в игру каждый день <span class="xp-amount">+3 опыта</span></li>
                <li><strong class="xp-source-outfit">Комплект одежды</strong> — за полный собранный комплект <span class="xp-amount">+20 опыта</span></li>
            </ul>
            <p>Чем выше уровень, тем больше бонусов и наград.</p>
            <button type="button" class="info-modal-close" onclick="closeXpModal()">Понятно</button>
        </div>
    </div>
    
    <!-- Модальное окно Май коины -->
    <div id="gold-modal" class="info-modal" onclick="if(event.target===this) closeGoldModal()">
        <div class="info-modal-content">
            <h3>🪙 МАЙ КОИНЫ — когда и за что</h3>
            <p>Здесь отображаются последние начисления и списания монет.</p>
            <div id="gold-history-list">
                <div class="gold-history-item">
                    <div><span class="gold-history-reason">Ежедневный бонус за вход</span><div class="gold-history-date">Сегодня, 10:30</div></div>
                    <span class="gold-history-amount">+50</span>
                </div>
                <div class="gold-history-item">
                    <div><span class="gold-history-reason">Достижение «Первые шаги»</span><div class="gold-history-date">Вчера</div></div>
                    <span class="gold-history-amount">+100</span>
                </div>
                <div class="gold-history-item">
                    <div><span class="gold-history-reason">Открыта карточка</span><div class="gold-history-date">28 янв</div></div>
                    <span class="gold-history-amount">+30</span>
                </div>
                <div class="gold-history-item">
                    <div><span class="gold-history-reason">Покупка в магазине</span><div class="gold-history-date">27 янв</div></div>
                    <span class="gold-history-amount">−200</span>
                </div>
            </div>
            <button type="button" class="info-modal-close" onclick="closeGoldModal()">Понятно</button>
        </div>
    </div>
    
    <!-- Модальное окно бонуса набора -->
    <div id="set-bonus-modal" class="info-modal" onclick="if(event.target===this) closeSetBonusModal()">
        <div class="info-modal-content">
            <h3 class="info-modal-title-with-icon"><span class="info-modal-title-icon">⭐</span> Бонус набора</h3>
            <p id="set-bonus-modal-text">Соберите полный комплект одежды из одного набора — получите бонус к опыту или Май коинам.</p>
            <button type="button" class="info-modal-close" onclick="closeSetBonusModal()">Понятно</button>
        </div>
    </div>
    
    <!-- Модальное окно задания (подробная инструкция) -->
    <div id="quest-modal" class="info-modal" onclick="if(event.target===this) closeQuestModal()">
        <div class="info-modal-content">
            <h3 class="info-modal-title-with-icon"><span class="info-modal-title-icon">📋</span> <span id="quest-modal-title">Задание</span></h3>
            <p id="quest-modal-instruction">Подробная инструкция по выполнению задания.</p>
            <p class="quest-modal-reward" id="quest-modal-reward">Награда: —</p>
            <button type="button" class="info-modal-close" onclick="closeQuestModal()">Понятно</button>
        </div>
    </div>
    
    <!-- Модальное окно выбора одежды -->
    <div id="clothing-modal" class="clothing-modal">
        <div class="clothing-modal-content">
            <button class="clothing-modal-close-top" onclick="closeClothingModal()">×</button>
            <div class="clothing-modal-body">
                <!-- Блок 1: ПРОСМОТР ВЫБРАННОГО ПРЕДМЕТА -->
                <div class="clothing-section">
                    <div class="clothing-section-title clothing-section-title-green">ПРОСМОТР ВЫБРАННОГО ПРЕДМЕТА</div>
                    <div class="clothing-preview-top">
                        <div class="clothing-preview-icon" id="clothing-preview-image">
                            <span class="clothing-preview-placeholder">Выберите вещь</span>
                        </div>
                        <div class="clothing-preview-info">
                            <div class="clothing-preview-name" id="clothing-preview-name">—</div>
                            <div class="clothing-preview-description" id="clothing-preview-description">—</div>
                            <div class="clothing-preview-actions">
                                <button class="clothing-select-button" id="clothing-select-button" onclick="selectClothingItem()" disabled>Надеть</button>
                                <button class="clothing-remove-button" id="clothing-remove-button" onclick="removeClothingItem()" disabled>Снять</button>
                            </div>
                            <div class="clothing-how-to-get" id="clothing-how-to-get">
                                <div class="clothing-how-to-get-title">Как получить</div>
                                <div class="clothing-how-to-get-text" id="clothing-how-to-get-text">—</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Блок 2: НАБОР ВЫБРАННОГО ПРЕДМЕТА -->
                <div class="clothing-section">
                    <div class="clothing-section-title clothing-section-title-purple">НАБОР ВЫБРАННОГО ПРЕДМЕТА</div>
                    <div class="clothing-set-row" id="clothing-set-row">
                        <div class="clothing-set-info">
                            <div class="clothing-set-name" id="clothing-set-name">Соберите комплект</div>
                            <div class="clothing-set-icons" id="clothing-set-icons">
                                <div class="clothing-set-slot" data-slot="head" title="Голова"><div class="clothing-set-slot-img"></div></div>
                                <div class="clothing-set-slot" data-slot="body" title="Туловище"><div class="clothing-set-slot-img"></div></div>
                                <div class="clothing-set-slot" data-slot="legs" title="Ноги"><div class="clothing-set-slot-img"></div></div>
                                <div class="clothing-set-slot" data-slot="shoes" title="Обувь"><div class="clothing-set-slot-img"></div></div>
                            </div>
                        </div>
                        <button class="clothing-wear-set-button" id="clothing-wear-set-button" type="button" onclick="wearFullOutfitSet()" disabled>НАДЕТЬ ВЕСЬ НАБОР</button>
                    </div>
                </div>
                
                <!-- Блок 3: КОЛЛЕКЦИЯ ПРЕДМЕТОВ -->
                <div class="clothing-section">
                    <div class="clothing-section-title clothing-section-title-blue">КОЛЛЕКЦИЯ ПРЕДМЕТОВ</div>
                    <div class="clothing-grid-wrap">
                        <div class="clothing-items-grid" id="clothing-items-grid"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно просмотра карточки -->
    <div id="card-modal" class="card-modal">
        <div class="card-modal-content">
            <button class="card-modal-close" onclick="closeCardModal()">×</button>
            <div class="card-modal-name" id="card-modal-name">Название карты</div>
            <div class="card-3d-container">
                <div class="card-3d" id="card-3d">
                    <div class="card-3d-face card-3d-face-front">
                        <img id="card-3d-image" src="" alt="Card">
                    </div>
                    <div class="card-3d-face card-3d-face-back"></div>
                </div>
            </div>
            <div class="card-rotation-controls">
                <button class="card-rotation-btn" onclick="rotateCard('left')">← Повернуть</button>
                <button class="card-rotation-btn" onclick="rotateCard('right')">Повернуть →</button>
            </div>
            <div class="card-modal-description" id="card-modal-description">Описание карты</div>
        </div>
    </div>
    
    <!-- Уведомление о новых картах -->
    <div id="notification" class="notification">
        <span class="notification-body" id="notification-body">У вас новые <span class="notification-cards-word">карты</span>, посмотрите!</span>
        <span class="notification-close" id="notification-close" aria-label="Закрыть">×</span>
    </div>
    
    <button id="btn-confirm-gender" class="main-button" onclick="goToCharacterSelection()">Далее</button>
    <button id="btn-confirm-character" class="main-button" style="display: none;" onclick="confirmCharacter()">Выбрать</button>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let selectedGender = null;
        let swiperInstance = null;
        let selectedCharacter = {};
        let areTabsInitialized = false;
        var completedQuestIds = new Set(['daily-1', 'daily-2']);

        const AppData = {
            repoUrl: 'https://raw.githubusercontent.com/Mayhelper/game_tpop/main/images/',
            loaderBackground: 'loader-bg.png', // Фоновая заставка для экрана загрузки (если есть)
            characters: { 
                male: [
                    { id: 'male-1', bg: '#039BE5', title: 'ВСЕГДА С ИГОЛОЧКИ', description: 'ГОТОВ ПОКОРИТЬ ЛЮБЫЕ ТОЧКИ' },
                    { id: 'male-2', bg: '#FF6F00', title: 'ДУША КОМПАНИИ', description: 'НАХОДИТ ОБЩИЙ ЯЗЫК С КЕМ УГОДНО' },
                    { id: 'male-3', bg: '#00897B', title: 'КРЕАТИВНЫЙ ГЕНИЙ', description: 'МЫСЛИТ НЕСТАНДАРТНО И ПОЛОН ИДЕЙ' },
                    { id: 'male-4', bg: '#5E35B1', title: 'ПРИРОЖДЕННЫЙ ЛИДЕР', description: 'ВЕДЕТ КОМАНДУ К НОВЫМ ВЕРШИНАМ' },
                    { id: 'male-5', bg: '#3949AB', title: 'МАСТЕР СВОЕГО ДЕЛА', description: 'ЗНАЕТ ВСЕ ТОНКОСТИ УСПЕХА' },
                ],
                female: [
                    { id: 'female-1', bg: '#D81B60', title: 'ЗВЕЗДА ПЕРЕГОВОРОВ', description: 'УБЕДИТ КОГО УГОДНО И ЗАКЛЮЧИТ СДЕЛКУ' },
                    { id: 'female-2', bg: '#1E88E5', title: 'МИСС ЭЛЕГАНТНОСТЬ', description: 'СОЧЕТАЕТ СТИЛЬ, УМ И ДЕЛОВУЮ ХВАТКУ' },
                    { id: 'female-3', bg: '#7CB342', title: 'ГЕНЕРАТОР ИДЕЙ', description: 'ЕЕ КРЕАТИВНОСТЬ НЕ ЗНАЕТ ГРАНИЦ' },
                    { id: 'female-4', bg: '#E53935', title: 'ПРИНЦЕССА ВРЕМЕНИ', description: 'УСПЕВАЕТ ВСЕ И ДАЖЕ БОЛЬШЕ' },
                    { id: 'female-5', bg: '#8E24AA', title: 'КОРОЛЕВА ЛИДЕРСТВА', description: 'СТРОИТ ПРОЧНЫЕ МОСТЫ МЕЖДУ ЛЮДЬМИ' },
                ]
            },
            cards: [
                { id: 'card-1', name: 'Карта 1', description: 'Мощная карта для начала игры. Дает бонус к опыту.', image: 'cards/card-1.png', glowColor: 'silver' },
                { id: 'card-2', name: 'Карта 2', description: 'Уникальная карта с особыми способностями. Увеличивает здоровье.', image: 'cards/card-2.png' },
                { id: 'card-3', name: 'Карта 3', description: 'Редкая карта коллекционера. Повышает удачу.', image: 'cards/card-3.png' },
                { id: 'card-4', name: 'Карта 4', description: 'Легендарная карта. Дает огромные преимущества.', image: 'cards/card-4.png', glowColor: 'gold' },
                { id: 'card-5', name: 'Карта 5', description: 'Эпическая карта. Максимальные характеристики.', image: 'cards/card-5.png', glowColor: 'purple' },
                { id: 'card-6', name: 'Карта 6', description: 'Новая карта! Специальные возможности.', image: 'cards/card-6.png' }
            ],
            badges: [
                { text: '⭐' }, { text: '🏆' }, { text: '💎' }, { text: '💡' }, { text: '🚀' }
            ],
            quests: {
                daily: [
                    { id: 'daily-1', title: 'Зайти в приложение', instruction: 'Откройте мини-приложение May Games в течение дня. Достаточно одного входа — награда займёт в игру автоматически.', reward: '+3 опыта, +50 Май коинов' },
                    { id: 'daily-2', title: 'Отметить присутствие', instruction: 'На главном экране нажмите кнопку «Отметить присутствие» (или аналогичную). Отметка сохраняется до конца дня.', reward: '+5 Май коинов' },
                    { id: 'monthly-view', title: 'Посмотреть планы на месяц', instruction: 'Откройте вкладку «На месяц» в разделе «Задания», чтобы увидеть месячные цели и награды.', reward: '+10 Май коинов' },
                    { id: 'daily-3', title: 'Просмотреть одну карточку', instruction: 'Откройте раздел «Карточки», выберите любую карточку и откройте её (нажмите на карточку). Просмотр описание карты засчитывается как выполнение.', reward: '+2 опыта' },
                    { id: 'daily-4', title: 'Сменить элемент одежды', instruction: 'Зайдите в слоты одежды (голова, тело, ноги или обувь), выберите любой предмет и нажмите «Выбрать». Смена хотя бы одного элемента засчитывается.', reward: '+5 Май коинов' },
                ],
                monthly: [
                    { id: 'monthly-1', title: 'Посетить приложение 20 дней', instruction: 'В течение календарного месяца зайдите в приложение не менее 20 разных дней. Дни не обязательно подряд — учитывается общее количество дней с входом.', reward: '+50 опыта, +200 Май коинов' },
                    { id: 'monthly-2', title: 'Собрать полный комплект одежды', instruction: 'Подберите и наденьте полный комплект из одного набора (голова, тело, ноги, обувь из одного набора в разделе «Наборы»). Комплект должен быть сохранён хотя бы один раз за месяц.', reward: '+30 опыта, бонус набора' },
                    { id: 'monthly-3', title: 'Открыть 5 новых карточек', instruction: 'В разделе «Карточки» откройте не менее 5 карточек, которых ещё не было в вашей коллекции. Учитываются только новые карты за текущий месяц.', reward: '+40 опыта, +100 Май коинов' },
                ],
                additional: [
                    { id: 'add-1', title: 'Предложить идею для игры', instruction: 'Напишите идею или предложение по улучшению в специальную форму (или в чат обратной связи). Идея должна быть развёрнутой: что добавить или изменить и зачем.', reward: '+15 опыта' },
                    { id: 'add-2', title: 'Поделиться достижением', instruction: 'Выполните любое достижение из раздела «Достижения», затем нажмите «Поделиться» (если доступно) или сделайте скриншот и поделитесь в рабочем чате или со знакомыми.', reward: '+20 Май коинов' },
                    { id: 'add-3', title: 'Пройдите обучение', instruction: 'Если вы новый пользователь — пройдите краткое обучение в приложении (подсказки при первом запуске). Если уже проходили — задание не засчитывается повторно.', reward: '+25 опыта, достижение «Первые шаги»' },
                ],
            },
            achievements: [
                { text: '✅ Первые шаги: Завершить обучение' }, { text: '✅ Новатор: Предложить 5 идей' },
                { text: '🔒 Командный игрок: Завершить проект' }, { text: '🔒 Лидер мнений: Выступить на встрече' },
            ],
            clothing: {
                // Путь к изображениям одежды на GitHub: clothing/{тип}/{id}.png
                // howToGet — текст «Как получить» вещь
                head: [
                    { id: 'chain-gold', name: 'Золотая цепочка', description: 'Тонкий акцент делового образа', image: 'clothing/head/chain-gold.png', howToGet: 'Посетить 10 заправок партнёра' },
                    { id: 'cap-90', name: 'Бейсболка с символикой', description: 'Легендарный стиль девяностых', image: 'clothing/head/cap-90.png', howToGet: 'Посетить 5 гипермаркетов' },
                    { id: 'hat-spy', name: 'Шляпа шпиона', description: 'Классическая шляпа для стиля детектива', image: 'clothing/head/hat-spy.png', howToGet: 'Собрать 3 карты из одной серии' },
                    { id: 'cap-1', name: 'Бейсболка', description: 'Спортивный стиль для неформальных встреч', image: 'clothing/head/cap-1.png', howToGet: 'Достичь 5 уровня' },
                    { id: 'helmet-1', name: 'Каска', description: 'Для работы на стройке', image: 'clothing/head/helmet-1.png', howToGet: 'Выполнить 5 заказов' },
                    { id: 'crown-sales-male', name: 'Корона короля продаж', description: 'Секретный комплект. Только у лидера по продажам в месяце.', image: 'clothing/head/crown-sales-male.png', howToGet: 'Максимум продаж в месяце — один игрок.' },
                    { id: 'crown-sales-female', name: 'Корона королевы продаж', description: 'Секретный комплект. Только у лидера по продажам в месяце.', image: 'clothing/head/crown-sales-female.png', howToGet: 'Максимум продаж в месяце — один игрок.' },
                ],
                body: [
                    { id: 'suit-office', name: 'Офисный костюм', description: 'Безупречный крой для переговоров и карьеры', image: 'clothing/body/suit-office.png', howToGet: 'Получить 500 Май коинов' },
                    { id: 'jacket-sport', name: 'Спортивная куртка', description: 'Ветер девяностых в каждом шве', image: 'clothing/body/jacket-sport.png', howToGet: 'Посетить 7 АЗС в одном месяце' },
                    { id: 'coat-spy', name: 'Пальто шпиона', description: 'Длинное пальто для незаметности', image: 'clothing/body/coat-spy.png', howToGet: 'Достичь 10 уровня опыта' },
                    { id: 'shirt-1', name: 'Рубашка', description: 'Официальная рубашка', image: 'clothing/body/shirt-1.png', howToGet: 'Посетить 3 магазина партнёра' },
                    { id: 'shirt-safari', name: 'Рубашка сафари', description: 'Прочная рубашка для походов и исследований', image: 'clothing/body/shirt-safari.png', howToGet: 'Достичь 7 уровня' },
                    { id: 'hoodie-1', name: 'Толстовка', description: 'Неформальный стиль', image: 'clothing/body/hoodie-1.png', howToGet: 'Пригласить друга' },
                    { id: 'suit-sales-male', name: 'Костюм короля продаж', description: 'Секретный комплект. Только у лидера по продажам в месяце.', image: 'clothing/body/suit-sales-male.png', howToGet: 'Максимум продаж в месяце — один игрок.' },
                    { id: 'suit-sales-female', name: 'Костюм королевы продаж', description: 'Секретный комплект. Только у лидера по продажам в месяце.', image: 'clothing/body/suit-sales-female.png', howToGet: 'Максимум продаж в месяце — один игрок.' },
                ],
                legs: [
                    { id: 'skirt-pencil', name: 'Юбка-карандаш', description: 'Классика офисного стиля и уверенности', image: 'clothing/legs/skirt-pencil.png', howToGet: 'Выполнить 5 заказов в приложении' },
                    { id: 'pants-sport', name: 'Спортивные штаны', description: 'Расслабленный дух эпохи 90-х', image: 'clothing/legs/pants-sport.png', howToGet: 'Посетить 3 разных магазина партнёра' },
                    { id: 'pants-spy', name: 'Штаны шпиона', description: 'Классические штаны под пальто', image: 'clothing/legs/pants-spy.png', howToGet: 'Активировать 10 промокодов' },
                    { id: 'jeans-1', name: 'Джинсы', description: 'Удобные джинсы', image: 'clothing/legs/jeans-1.png', howToGet: 'Заработать 500 Май коинов' },
                    { id: 'pants-safari', name: 'Штаны сафари', description: 'Удобные штаны для походов', image: 'clothing/legs/pants-safari.png', howToGet: 'Посетить 8 разных магазинов партнёра' },
                    { id: 'shorts-1', name: 'Шорты', description: 'Для жаркой погоды', image: 'clothing/legs/shorts-1.png', howToGet: 'Пригласить друга в программу' },
                    { id: 'pants-sales-male', name: 'Штаны короля продаж', description: 'Секретный комплект. Только у лидера по продажам в месяце.', image: 'clothing/legs/pants-sales-male.png', howToGet: 'Максимум продаж в месяце — один игрок.' },
                    { id: 'pants-sales-female', name: 'Юбка королевы продаж', description: 'Секретный комплект. Только у лидера по продажам в месяце.', image: 'clothing/legs/pants-sales-female.png', howToGet: 'Максимум продаж в месяце — один игрок.' },
                ],
                shoes: [
                    { id: 'heels', name: 'Туфли на каблуке', description: 'Элегантный шаг к успеху', image: 'clothing/shoes/heels.png', howToGet: 'Активировать 20 промокодов' },
                    { id: 'sneakers-white', name: 'Белые кроссовки', description: 'Чистый ретро-вид, как в лучшие годы', image: 'clothing/shoes/sneakers-white.png', howToGet: 'Заработать 1000 Май коинов' },
                    { id: 'boots-black', name: 'Черные ботинки', description: 'Строгие черные ботинки для образа шпиона', image: 'clothing/shoes/boots-black.png', howToGet: 'Посетить 15 заправок за месяц' },
                    { id: 'sneakers-1', name: 'Кроссовки', description: 'Удобные кроссовки', image: 'clothing/shoes/sneakers-1.png', howToGet: 'Достичь 8 уровня' },
                    { id: 'boots-1', name: 'Ботинки', description: 'Надежные ботинки', image: 'clothing/shoes/boots-1.png', howToGet: 'Выполнить 10 заказов' },
                    { id: 'boots-hiking', name: 'Походные ботинки', description: 'Надёжная обувь для походов', image: 'clothing/shoes/boots-hiking.png', howToGet: 'Выполнить 15 заказов' },
                    { id: 'shoes-sales-male', name: 'Туфли короля продаж', description: 'Секретный комплект. Только у лидера по продажам в месяце.', image: 'clothing/shoes/shoes-sales-male.png', howToGet: 'Максимум продаж в месяце — один игрок.' },
                    { id: 'shoes-sales-female', name: 'Туфли королевы продаж', description: 'Секретный комплект. Только у лидера по продажам в месяце.', image: 'clothing/shoes/shoes-sales-female.png', howToGet: 'Максимум продаж в месяце — один игрок.' },
                ]
            },
            // Комплекты: 0=офис, 1=90-х, 2=шпион, 3=первооткрыватель, 4=король продаж (м), 5=королева продаж (ж)
            outfitSets: [
                { id: 'office', name: 'Офисный стиль', head: 'chain-gold', body: 'suit-office', legs: 'skirt-pencil', shoes: 'heels', bonus: 'Бонус: +15% к Май коинам в будни. Образ переговорщика и лидера.' },
                { id: 'style90', name: 'Стиль 90-х', head: 'cap-90', body: 'jacket-sport', legs: 'pants-sport', shoes: 'sneakers-white', bonus: 'Бонус: +10% к опыту. Ностальгия и уверенный уличный стиль.' },
                { id: 'spy', name: 'Шпион', head: 'hat-spy', body: 'coat-spy', legs: 'pants-spy', shoes: 'boots-black', bonus: 'Бонус: +12% к опыту. Стиль детектива и скрытности.' },
                { id: 'explorer', name: 'Первооткрыватель', head: 'helmet-1', body: 'shirt-safari', legs: 'pants-safari', shoes: 'boots-hiking', bonus: 'Бонус: +8% к опыту за задания. Стиль исследователя и путешественника.' },
                { id: 'sales-king', name: 'Король продаж', gender: 'male', head: 'crown-sales-male', body: 'suit-sales-male', legs: 'pants-sales-male', shoes: 'shoes-sales-male', bonus: 'Секретный комплект. Только один игрок в месяц — лидер по количеству продаж. Супер бонус: x2 Май коинов за все активности.' },
                { id: 'sales-queen', name: 'Королева продаж', gender: 'female', head: 'crown-sales-female', body: 'suit-sales-female', legs: 'pants-sales-female', shoes: 'shoes-sales-female', bonus: 'Секретный комплект. Только один игрок в месяц — лидер по количеству продаж. Супер бонус: x2 Май коинов за все активности.' }
            ]
        };
        
        // Хранилище выбранной одежды
        let selectedClothing = {
            head: null,
            body: null,
            legs: null,
            shoes: null
        };
        
        let currentClothingType = null;
        let currentSelectedClothingItem = null;
        
        // --- ФУНКЦИЯ ПРЕДЗАГРУЗКИ ИЗОБРАЖЕНИЙ ---
        function preloadImages() {
            // Предзагружаем фоновую заставку
            if (AppData.loaderBackground) {
                const bgImage = new Image();
                bgImage.src = AppData.repoUrl + AppData.loaderBackground;
                bgImage.onload = function() {
                    const loaderScreen = document.getElementById('screen-loader');
                    loaderScreen.style.background = `url('${AppData.repoUrl}${AppData.loaderBackground}') center/cover, linear-gradient(135deg, #667eea 0%, #764ba2 100%)`;
                };
            }
            
            const imagesToLoad = [];
            
            // Собираем все изображения персонажей
            Object.values(AppData.characters.male).forEach(char => {
                imagesToLoad.push(AppData.repoUrl + char.id + '.png');
            });
            Object.values(AppData.characters.female).forEach(char => {
                imagesToLoad.push(AppData.repoUrl + char.id + '.png');
            });
            
            // Добавляем фон
            imagesToLoad.push(AppData.repoUrl + 'game-bg.png');
            
            // Варианты в костюмах: для каждого персонажа .1, .2, .3, .4 по числу комплектов
            const outfitCount = (AppData.outfitSets && AppData.outfitSets.length) || 4;
            ['male', 'female'].forEach(g => {
                (AppData.characters[g] || []).forEach(char => {
                    for (let v = 1; v <= outfitCount; v++) {
                        imagesToLoad.push(AppData.repoUrl + char.id + '.' + v + '.png');
                    }
                });
            });
            
            // Собираем все изображения одежды
            Object.values(AppData.clothing).forEach(category => {
                category.forEach(item => {
                    imagesToLoad.push(AppData.repoUrl + item.image);
                });
            });
            
            // Собираем все изображения карточек
            if (AppData.cards && AppData.cards.length) {
                AppData.cards.forEach(card => {
                    imagesToLoad.push(AppData.repoUrl + card.image);
                });
            }
            
            let loadedCount = 0;
            const totalImages = imagesToLoad.length;
            const progressBar = document.getElementById('loader-progress-bar');
            const progressText = document.getElementById('loader-progress-text');
            
            // Функция обновления прогресса
            function updateProgress() {
                const percentage = Math.round((loadedCount / totalImages) * 100);
                progressBar.style.width = percentage + '%';
                if (progressText) progressText.textContent = percentage + '%';
            }
            
            // Загружаем все изображения
            const loadPromises = imagesToLoad.map((url, index) => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        loadedCount++;
                        updateProgress();
                        resolve(url);
                    };
                    img.onerror = () => {
                        // Продолжаем даже если изображение не загрузилось
                        loadedCount++;
                        updateProgress();
                        resolve(url); // Разрешаем промис, чтобы не блокировать загрузку
                    };
                    img.src = url;
                });
            });
            
            // После загрузки всех изображений
            Promise.all(loadPromises).then(() => {
                // Показываем кнопку "Начать"
                const startButton = document.getElementById('loader-start-button');
                startButton.classList.add('visible');
            });
        }
        
        // --- (JS-код без изменений в логике) ---
        const bodyEl = document.body;
        const screens = { 
            gender: document.getElementById('screen-gender'), 
            character: document.getElementById('screen-character-select'),
            gamification: document.getElementById('screen-gamification')
        };
        const buttons = { 
            confirmGender: document.getElementById('btn-confirm-gender'), 
            confirmCharacter: document.getElementById('btn-confirm-character'), 
            male: document.getElementById('btn-male'), female: document.getElementById('btn-female') 
        };
        const characterInfo = { 
            title: document.getElementById('character-title'), 
            description: document.getElementById('character-description') 
        };

        function selectGender(gender) {
            console.log('selectGender called with:', gender);
            selectedGender = gender;
            bodyEl.className = '';
            if (buttons.male) buttons.male.classList.remove('active-male');
            if (buttons.female) buttons.female.classList.remove('active-female');
            if (gender === 'male') {
                bodyEl.classList.add('theme-male-selection');
                if (buttons.male) buttons.male.classList.add('active-male');
            } else {
                bodyEl.classList.add('theme-female-selection');
                if (buttons.female) buttons.female.classList.add('active-female');
            }
            if (buttons.confirmGender) {
                console.log('Adding visible class to confirm button');
                buttons.confirmGender.classList.add('visible');
                console.log('Button classes:', buttons.confirmGender.className);
            } else {
                console.error('Confirm gender button not found');
            }
        }

        function goToCharacterSelection() {
            if (!selectedGender) return;
            const characterList = AppData.characters[selectedGender];
            const swiperWrapper = document.getElementById('character-swiper-wrapper');
            if (!swiperWrapper) {
                console.error('Swiper wrapper not found');
                return;
            }
            swiperWrapper.innerHTML = '';
            characterList.forEach(char => {
                const slide = document.createElement('div');
                slide.className = 'swiper-slide';
                slide.innerHTML = `<img src="${AppData.repoUrl + char.id + '.png'}" alt="${char.title}">`;
                swiperWrapper.appendChild(slide);
            });
            screens.gender.classList.remove('active');
            // Полностью скрываем кнопку "Далее"
            if (buttons.confirmGender) {
                buttons.confirmGender.style.display = 'none';
                buttons.confirmGender.classList.remove('visible');
                buttons.confirmGender.style.opacity = '0';
            }
            screens.character.classList.add('active');
            // Добавляем класс на body для CSS правил
            bodyEl.classList.add('character-selection-active');
            // Показываем кнопку "Выбрать этого"
            if (buttons.confirmCharacter) {
                buttons.confirmCharacter.style.display = 'block';
            }
            // Небольшая задержка для корректной инициализации Swiper после показа экрана
            setTimeout(() => {
                initSwiper();
            }, 100);
        }

        function initSwiper() {
            if (swiperInstance) {
                try {
                    swiperInstance.destroy(true, true);
                } catch(e) {
                    console.warn('Error destroying swiper:', e);
                }
            }
            // Используем более специфичный селектор для экрана выбора персонажа
            const swiperElement = screens.character ? screens.character.querySelector('.swiper') : null;
            if (!swiperElement) {
                console.error('Swiper element not found in character screen');
                return;
            }
            const paginationElement = swiperElement.querySelector('.swiper-pagination');
            if (!paginationElement) {
                console.error('Pagination element not found');
                return;
            }
            try {
                swiperInstance = new Swiper(swiperElement, {
                    effect: 'fade', 
                    fadeEffect: { crossFade: true },
                    grabCursor: true, 
                    loop: true,
                    pagination: { el: paginationElement, dynamicBullets: true },
                    on: {
                        slideChangeTransitionStart: () => {
                            if (characterInfo.title) characterInfo.title.classList.remove('animate-in');
                            if (characterInfo.description) characterInfo.description.classList.remove('animate-in');
                        },
                        slideChangeTransitionEnd: () => updateCharacterInfo(),
                        init: () => setTimeout(updateCharacterInfo, 100),
                    },
                });
            } catch(e) {
                console.error('Error initializing Swiper:', e);
            }
        }
        
        function updateCharacterInfo() {
            if (!swiperInstance || !selectedGender) return;
            const activeIndex = swiperInstance.realIndex;
            const currentCharacter = AppData.characters[selectedGender][activeIndex];
            bodyEl.style.backgroundColor = currentCharacter.bg;
            characterInfo.title.textContent = currentCharacter.title;
            characterInfo.description.textContent = currentCharacter.description;
            characterInfo.title.classList.add('animate-in');
            characterInfo.description.classList.add('animate-in');
            selectedCharacter = currentCharacter;
        }

        function confirmCharacter() {
            if (!selectedCharacter) return;
            document.getElementById('game-character-image').src = AppData.repoUrl + selectedCharacter.id + '.png';
            document.getElementById('game-character-image').alt = selectedCharacter.title;
            // Подпись под персонажем убрана
            
            // Устанавливаем фон из GitHub
            const screenGamification = document.getElementById('screen-gamification');
            screenGamification.style.backgroundImage = `url('${AppData.repoUrl}game-bg.png')`;
            
            screens.character.classList.remove('active');
            // Убираем класс с body
            bodyEl.classList.remove('character-selection-active');
            screens.gamification.classList.add('active');
            // Скрываем кнопку "Выбрать этого"
            if (buttons.confirmCharacter) {
                buttons.confirmCharacter.style.display = 'none';
            }
            
            document.getElementById('tabs-container').style.display = 'block';
            
            if (!areTabsInitialized) initGameTabs();
            applyOutfitSet(0);
        }

        function initGameTabs() {
            // Создаем карточки в grid - только реальные карты, без пустых слотов
            const cardsGrid = document.getElementById('cards-grid');
            if (cardsGrid) {
                cardsGrid.innerHTML = '';
                AppData.cards.forEach(card => {
                    const cardItem = document.createElement('div');
                    cardItem.className = 'card-item';
                    cardItem.onclick = () => openCardModal(card);
                    cardItem.innerHTML = `
                        <img src="${AppData.repoUrl + card.image}" alt="${card.name}" onerror="var n=this.alt; this.style.display='none'; this.parentElement.innerHTML='<div class=\'no-image-placeholder\' style=\'position:absolute;top:0;left:0;right:0;bottom:0;z-index:1\'>Нет изображения</div><div class=\'card-item-name\'>'+n+'</div>'">
                        <div class="card-item-name">${card.name}</div>
                    `;
                    // Убеждаемся, что карточка имеет position: relative для правильного позиционирования
                    cardItem.style.position = 'relative';
                    cardsGrid.appendChild(cardItem);
                });
            }
            
            renderQuestLists();
            const achievementsList = document.getElementById('achievements-list');
            AppData.achievements.forEach(ach => {
                achievementsList.innerHTML += `<li>${ach.text}</li>`;
            });

            areTabsInitialized = true;
            
            // Показываем уведомление о новых картах
            setTimeout(() => {
                showNotification();
            }, 1000);
        }
        
        // Функции для модального окна карточки
        let currentCardRotation = { x: 0, y: 0 };
        let currentCard = null;
        let cardModalDragHandlers = null;
        
        function openCardModal(card) {
            currentCard = card;
            currentCardRotation = { x: 0, y: 0 };
            const modal = document.getElementById('card-modal');
            const cardName = document.getElementById('card-modal-name');
            const cardDescription = document.getElementById('card-modal-description');
            const card3d = document.getElementById('card-3d');
            const card3dFace = card3d.querySelector('.card-3d-face-front');
            
            cardName.textContent = card.name;
            cardDescription.textContent = card.description;
            
            if (card3dFace) {
                card3dFace.innerHTML = '<img id="card-3d-image" src="" alt="Card">';
            }
            const cardImg = document.getElementById('card-3d-image');
            if (cardImg) {
                cardImg.src = AppData.repoUrl + card.image;
                cardImg.alt = card.name;
                cardImg.onerror = function() {
                    if (card3dFace) {
                        card3dFace.innerHTML = '<div class="no-image-placeholder">Нет изображения</div>';
                    }
                };
            }
            
            card3d.style.transform = 'rotateX(0deg) rotateY(0deg)';
            updateCardGloss(card3d);
            card3d.classList.remove('card-3d-dragging');
            
            if (card3dFace) {
                card3dFace.classList.remove('glow-silver', 'glow-gold', 'glow-blue', 'glow-purple');
            }
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';
            
            let isDragging = false;
            let startX = 0;
            let startY = 0;
            
            const handleMouseDown = (e) => {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                card3d.classList.add('card-3d-dragging');
                e.preventDefault();
            };
            
            const handleTouchStart = (e) => {
                if (e.touches.length === 1) {
                    isDragging = true;
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    card3d.classList.add('card-3d-dragging');
                    e.preventDefault();
                }
            };
            
            const handleMove = (clientX, clientY) => {
                if (!isDragging) return;
                const deltaX = clientX - startX;
                const deltaY = clientY - startY;
                currentCardRotation.y += deltaX * 0.5;
                currentCardRotation.x -= deltaY * 0.5;
                currentCardRotation.x = Math.max(-30, Math.min(30, currentCardRotation.x));
                card3d.style.transform = `rotateX(${currentCardRotation.x}deg) rotateY(${currentCardRotation.y}deg)`;
                updateCardGloss(card3d);
                startX = clientX;
                startY = clientY;
            };
            
            const handleMouseMove = (e) => {
                if (isDragging) {
                    handleMove(e.clientX, e.clientY);
                    e.preventDefault();
                }
            };
            
            const handleTouchMove = (e) => {
                if (isDragging && e.touches[0]) {
                    handleMove(e.touches[0].clientX, e.touches[0].clientY);
                    e.preventDefault();
                }
            };
            
            const handleEnd = () => { 
                isDragging = false;
                card3d.classList.remove('card-3d-dragging');
            };
            
            card3d.addEventListener('mousedown', handleMouseDown);
            card3d.addEventListener('touchstart', handleTouchStart, { passive: false });
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('mouseup', handleEnd);
            document.addEventListener('touchend', handleEnd);
            document.addEventListener('touchcancel', handleEnd);
            
            cardModalDragHandlers = {
                mouseDown: handleMouseDown,
                touchStart: handleTouchStart,
                mouseMove: handleMouseMove,
                touchMove: handleTouchMove,
                end: handleEnd
            };
            
            if (tg && tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        }
        
        function closeCardModal() {
            const modal = document.getElementById('card-modal');
            const card3d = document.getElementById('card-3d');
            if (card3d) card3d.classList.remove('card-3d-dragging');
            if (cardModalDragHandlers && card3d) {
                card3d.removeEventListener('mousedown', cardModalDragHandlers.mouseDown);
                card3d.removeEventListener('touchstart', cardModalDragHandlers.touchStart);
                document.removeEventListener('mousemove', cardModalDragHandlers.mouseMove);
                document.removeEventListener('touchmove', cardModalDragHandlers.touchMove);
                document.removeEventListener('mouseup', cardModalDragHandlers.end);
                document.removeEventListener('touchend', cardModalDragHandlers.end);
                document.removeEventListener('touchcancel', cardModalDragHandlers.end);
                cardModalDragHandlers = null;
            }
            modal.classList.remove('active');
            currentCard = null;
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.width = '';
        }
        
        function rotateCard(direction) {
            const card3d = document.getElementById('card-3d');
            if (!card3d) return;
            
            if (direction === 'left') {
                currentCardRotation.y -= 15;
            } else {
                currentCardRotation.y += 15;
            }
            
            card3d.style.transform = `rotateX(${currentCardRotation.x}deg) rotateY(${currentCardRotation.y}deg)`;
            updateCardGloss(card3d);
        }
        
        function updateCardGloss(card3dEl) {
            if (!card3dEl) return;
            var rx = currentCardRotation.x, ry = currentCardRotation.y;
            var glossX = 50 + ry * 0.55;
            var glossY = 50 - rx * 0.55;
            glossX = Math.max(10, Math.min(90, glossX));
            glossY = Math.max(10, Math.min(90, glossY));
            card3dEl.style.setProperty('--gloss-x', glossX + '%');
            card3dEl.style.setProperty('--gloss-y', glossY + '%');
            var tilt = (Math.abs(rx) + Math.abs(ry)) / 90;
            var shadowStrength = Math.min(1, tilt * 1.4);
            card3dEl.style.setProperty('--shadow-strength', shadowStrength.toFixed(2));
        }
        
        // Функции для уведомления (остаётся до закрытия или смахивания)
        function showNotification() {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.classList.remove('notification-dismissing');
                notification.classList.add('active');
            }
        }
        
        function closeNotification() {
            const notification = document.getElementById('notification');
            if (!notification || !notification.classList.contains('active')) return;
            notification.classList.add('notification-dismissing');
            setTimeout(() => {
                notification.classList.remove('active', 'notification-dismissing');
            }, 350);
        }
        
        function openCardsFromNotification() {
            const btn = document.getElementById('tab-btn-cards');
            if (btn) switchTab('cards', btn);
            closeNotification();
        }
        
        (function initNotificationHandlers() {
            const notification = document.getElementById('notification');
            const body = document.getElementById('notification-body');
            const closeBtn = document.getElementById('notification-close');
            if (!notification) return;
            if (body) body.addEventListener('click', function(e) { e.stopPropagation(); openCardsFromNotification(); });
            if (closeBtn) closeBtn.addEventListener('click', function(e) { e.stopPropagation(); closeNotification(); });
            var touchStartY = 0;
            notification.addEventListener('touchstart', function(e) { touchStartY = e.touches[0].clientY; }, { passive: true });
            notification.addEventListener('touchend', function(e) {
                var touchEndY = e.changedTouches[0].clientY;
                if (touchStartY - touchEndY > 50) closeNotification();
            }, { passive: true });
        })();
        
        // Закрытие модального окна карточки при клике вне его
        document.getElementById('card-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCardModal();
            }
        });

        function switchTab(tabId, clickedButton) {
            document.documentElement.style.setProperty('--active-tab-color', clickedButton.dataset.color);
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            clickedButton.classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }
        
        function renderQuestLists() {
            const quests = AppData.quests || { daily: [], monthly: [], additional: [] };
            ['daily', 'monthly', 'additional'].forEach(cat => {
                const listEl = document.getElementById('quest-list-' + cat);
                if (!listEl) return;
                listEl.innerHTML = '';
                (quests[cat] || []).forEach(q => {
                    const completed = completedQuestIds.has(q.id);
                    const li = document.createElement('li');
                    li.className = 'quest-item' + (completed ? ' completed' : ' in-progress');
                    const statusText = completed ? 'Выполнено' : 'Невыполнено';
                    li.innerHTML = `<span class="quest-item-title">${completed ? '✅ ' : ''}${q.title}</span><br><span class="quest-item-reward">${formatRewardHtml(q.reward)}</span><br><span class="quest-item-status">${statusText}</span>`;
                    li.onclick = () => openQuestModal(q);
                    listEl.appendChild(li);
                });
            });
        }
        
        function switchQuestSubTab(category, clickedButton) {
            document.querySelectorAll('.quest-sub-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.quest-list').forEach(list => list.classList.remove('active'));
            if (clickedButton) clickedButton.classList.add('active');
            if (category === 'monthly') {
                completedQuestIds.add('monthly-view');
                renderQuestLists();
            }
            const listEl = document.getElementById('quest-list-' + category);
            if (listEl) listEl.classList.add('active');
        }
        
        function formatRewardHtml(rewardStr) {
            if (!rewardStr) return '—';
            var s = rewardStr.replace(/XP/gi, 'Опыт').replace(/May Coins/gi, 'Май коины');
            return s.split(',').map(function(part) {
                part = part.trim();
                if (!part) return '';
                if (/опыта|Опыт/i.test(part)) return '<span class="reward-exp">' + part + '</span>';
                if (/Май коинов|Май коины/i.test(part)) return '<span class="reward-coins">' + part + '</span>';
                return part;
            }).filter(Boolean).join(', ');
        }
        
        function openQuestModal(quest) {
            if (!quest) return;
            document.getElementById('quest-modal-title').textContent = quest.title;
            document.getElementById('quest-modal-instruction').textContent = quest.instruction;
            var rewardEl = document.getElementById('quest-modal-reward');
            rewardEl.innerHTML = 'Награда: ' + formatRewardHtml(quest.reward);
            document.getElementById('quest-modal').classList.add('active');
            if (window.Telegram && window.Telegram.WebApp) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }
        function closeQuestModal() {
            document.getElementById('quest-modal').classList.remove('active');
        }
        
        // Функции для работы с одеждой
        function openShop() {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
            }
            alert('Магазин скоро откроется!');
        }
        
        function openHealthRulesModal() {
            const modal = document.getElementById('health-rules-modal');
            if (modal) modal.classList.add('active');
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
            }
        }
        function closeHealthRulesModal() {
            const modal = document.getElementById('health-rules-modal');
            if (modal) modal.classList.remove('active');
        }
        
        function openXpModal() {
            const modal = document.getElementById('xp-modal');
            if (modal) modal.classList.add('active');
            if (window.Telegram && window.Telegram.WebApp) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }
        function closeXpModal() {
            const modal = document.getElementById('xp-modal');
            if (modal) modal.classList.remove('active');
        }
        
        function openGoldModal() {
            const modal = document.getElementById('gold-modal');
            if (modal) modal.classList.add('active');
            if (window.Telegram && window.Telegram.WebApp) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }
        function closeGoldModal() {
            const modal = document.getElementById('gold-modal');
            if (modal) modal.classList.remove('active');
        }
        
        function openSetBonusModal() {
            const set = getCurrentOutfitSet();
            const textEl = document.getElementById('set-bonus-modal-text');
            if (textEl) textEl.textContent = set ? set.bonus : 'Соберите полный комплект одежды из одного набора — получите бонус к опыту или Май коинам.';
            const modal = document.getElementById('set-bonus-modal');
            if (modal) modal.classList.add('active');
            if (window.Telegram && window.Telegram.WebApp) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }
        function closeSetBonusModal() {
            const modal = document.getElementById('set-bonus-modal');
            if (modal) modal.classList.remove('active');
        }
        
        function fillClothingGridAndTitle(type) {
            const grid = document.getElementById('clothing-items-grid');
            grid.innerHTML = '';
            const items = AppData.clothing[type] || [];
            for (let i = 0; i < 9; i++) {
                const itemDiv = document.createElement('div');
                if (i < items.length) {
                    const item = items[i];
                    itemDiv.className = 'clothing-item';
                    itemDiv.onclick = (e) => selectClothingItemPreview(item, itemDiv);
                    if (selectedClothing[type] && selectedClothing[type].id === item.id) itemDiv.classList.add('active');
                    const img = document.createElement('img');
                    img.src = AppData.repoUrl + item.image;
                    img.alt = item.name;
                    img.onerror = function() {
                        if (item.image && item.image.includes('-female')) {
                            img.onerror = function() {
                                itemDiv.innerHTML = '<div class="no-image-placeholder">Нет изображения</div>';
                            };
                            img.src = AppData.repoUrl + item.image.replace('-female', '-male');
                        } else {
                            itemDiv.innerHTML = '<div class="no-image-placeholder">Нет изображения</div>';
                        }
                    };
                    itemDiv.appendChild(img);
                } else {
                    itemDiv.className = 'clothing-item locked';
                }
                grid.appendChild(itemDiv);
            }
            setTimeout(() => {
                if (selectedClothing[type]) {
                    const selectedItem = selectedClothing[type];
                    const previewImage = document.getElementById('clothing-preview-image');
                    const previewName = document.getElementById('clothing-preview-name');
                    const previewDescription = document.getElementById('clothing-preview-description');
                    const selectButton = document.getElementById('clothing-select-button');
                    const removeButton = document.getElementById('clothing-remove-button');
                    previewImage.innerHTML = '<img src="' + AppData.repoUrl + selectedItem.image + '" alt="' + selectedItem.name + '">';
                    previewName.textContent = selectedItem.name;
                    previewDescription.textContent = selectedItem.description;
                    const howToGetEl = document.getElementById('clothing-how-to-get-text');
                    if (howToGetEl) howToGetEl.textContent = selectedItem.howToGet || '—';
                    selectButton.disabled = false;
                    if (removeButton) removeButton.disabled = false;
                    const activeItem = Array.from(grid.children).find(child => {
                        const im = child.querySelector('img');
                        return im && im.alt === selectedItem.name;
                    });
                    if (activeItem) activeItem.classList.add('active');
                } else {
                    resetClothingPreview();
                }
                updateClothingSetIcons();
            }, 50);
        }
        
        function switchClothingType(type, btn) {
            currentClothingType = type;
            document.querySelectorAll('.clothing-type-tab').forEach(t => t.classList.remove('active'));
            if (btn) btn.classList.add('active');
            fillClothingGridAndTitle(type);
            updateClothingWearSetButton();
        }
        
        function openClothingModal(type) {
            currentClothingType = type;
            const modal = document.getElementById('clothing-modal');
            document.querySelectorAll('.clothing-type-tab').forEach(t => {
                t.classList.toggle('active', t.getAttribute('data-type') === type);
            });
            fillClothingGridAndTitle(type);
            modal.classList.add('active');
            updateClothingWearSetButton();
        }
        
        function closeClothingModal() {
            const modal = document.getElementById('clothing-modal');
            modal.classList.remove('active');
            currentSelectedClothingItem = null;
        }
        
        function selectClothingItemPreview(item, element) {
            currentSelectedClothingItem = item;
            
            // Обновляем активный элемент в сетке
            document.querySelectorAll('.clothing-item').forEach(el => el.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }
            
            // Обновляем превью
            const previewImage = document.getElementById('clothing-preview-image');
            const previewName = document.getElementById('clothing-preview-name');
            const previewDescription = document.getElementById('clothing-preview-description');
            const selectButton = document.getElementById('clothing-select-button');
            const removeButton = document.getElementById('clothing-remove-button');
            
            previewImage.innerHTML = `<img src="${AppData.repoUrl + item.image}" alt="${item.name}" onerror="this.parentElement.innerHTML='<div class=\'no-image-placeholder\'>Нет изображения</div>'">`;
            previewName.textContent = item.name;
            previewDescription.textContent = item.description;
            const howToGetEl = document.getElementById('clothing-how-to-get-text');
            if (howToGetEl) howToGetEl.textContent = item.howToGet || '—';
            selectButton.disabled = false;
            
            // Показываем кнопку "Снять" если эта вещь уже выбрана
            const isCurrentlySelected = selectedClothing[currentClothingType] && selectedClothing[currentClothingType].id === item.id;
            if (removeButton) {
                removeButton.disabled = !isCurrentlySelected;
            }
            updateClothingWearSetButton();
        }
        
        function resetClothingPreview() {
            const previewImage = document.getElementById('clothing-preview-image');
            const previewName = document.getElementById('clothing-preview-name');
            const previewDescription = document.getElementById('clothing-preview-description');
            const selectButton = document.getElementById('clothing-select-button');
            const removeButton = document.getElementById('clothing-remove-button');
            
            previewImage.innerHTML = '<span class="clothing-preview-placeholder">Выберите вещь</span>';
            previewName.textContent = '-';
            previewDescription.textContent = '-';
            const howToGetEl = document.getElementById('clothing-how-to-get-text');
            if (howToGetEl) howToGetEl.textContent = '—';
            selectButton.disabled = true;
            if (removeButton) {
                removeButton.disabled = true;
            }
            updateClothingWearSetButton();
        }
        
        // Функция снятия вещи
        function removeClothingItem() {
            if (!currentClothingType) return;
            
            // Удаляем вещь из выбранных
            selectedClothing[currentClothingType] = null;
            
            // Обновляем слот - возвращаем иконку
            const slot = document.querySelector(`[data-slot-type="${currentClothingType}"]`);
            if (slot) {
                slot.innerHTML = `<div class="clothing-slot-icon">${getSlotIcon(currentClothingType)}</div>`;
            }
            
            // Обновляем изображение персонажа
            updateCharacterImage();
            updateClothingSetDescription();
            
            // Обновляем кнопку "Снять" в превью
            const removeButton = document.getElementById('clothing-remove-button');
            if (removeButton) {
                removeButton.disabled = true;
            }
            updateClothingWearSetButton();
            
            // Обновляем активные элементы в сетке
            document.querySelectorAll('.clothing-item').forEach(el => el.classList.remove('active'));
            
            // Вибрация
            if (tg && tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        }
        
        function selectClothingItem() {
            if (!currentSelectedClothingItem || !currentClothingType) return;
            
            // Сохраняем выбранную вещь
            selectedClothing[currentClothingType] = currentSelectedClothingItem;
            
            // Обновляем слот
            const slot = document.querySelector(`[data-slot-type="${currentClothingType}"]`);
            if (slot) {
                slot.innerHTML = `<img src="${AppData.repoUrl + currentSelectedClothingItem.image}" alt="${currentSelectedClothingItem.name}" onerror="this.parentElement.innerHTML='<div class=\'no-image-placeholder\'>Нет изображения</div>'">`;
            }
            
            // Проверяем комбинацию самурая и обновляем персонажа
            updateCharacterImage();
            updateClothingSetDescription();
            
            // Активируем кнопку "Снять"
            const removeButton = document.getElementById('clothing-remove-button');
            if (removeButton) {
                removeButton.disabled = false;
            }
            
            // Закрываем модальное окно
            closeClothingModal();
            
            // Вибрация (если поддерживается)
            if (tg && tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }
        }
        
        // Функция обновления изображения персонажа
        // Без костюма: female-1, male-1 и т.д. В костюме: female-1.1, male-2.2 и т.д. (все персонажи)
        function updateCharacterImage() {
            const characterImage = document.getElementById('game-character-image');
            if (!characterImage || !selectedCharacter) return;
            
            characterImage.onerror = null;
            characterImage.onload = null;
            
            const set = getCurrentOutfitSet();
            if (set && AppData.outfitSets) {
                const setIndex = AppData.outfitSets.indexOf(set);
                if (setIndex >= 0) {
                    const variant = setIndex + 1;
                    const variantUrl = AppData.repoUrl + selectedCharacter.id + '.' + variant + '.png';
                    characterImage.alt = selectedCharacter.title + ' (' + (set.name || 'Комплект ' + variant) + ')';
                    // Для набора "Королева продаж" (variant 6): если нет картинки .6, показываем .5
                    if (variant === 6) {
                        characterImage.onerror = function() {
                            characterImage.onerror = null;
                            characterImage.src = AppData.repoUrl + selectedCharacter.id + '.5.png';
                            characterImage.onerror = function() {
                                characterImage.onerror = null;
                                characterImage.src = AppData.repoUrl + selectedCharacter.id + '.png';
                            };
                        };
                        characterImage.onload = function() { characterImage.onerror = null; characterImage.onload = null; };
                    }
                    characterImage.src = variantUrl;
                    return;
                }
            }
            characterImage.src = AppData.repoUrl + selectedCharacter.id + '.png';
            characterImage.alt = selectedCharacter.title;
        }
        
        function getSlotIcon(type) {
            const icons = {
                head: '👤',
                body: '👕',
                legs: '👖',
                shoes: '👟'
            };
            return icons[type] || '👕';
        }
        
        function getClothingItem(type, itemId) {
            const list = AppData.clothing[type];
            if (!list) return null;
            return list.find(item => item.id === itemId) || null;
        }
        
        function getCurrentOutfitSet() {
            if (!AppData.outfitSets) return null;
            for (const set of AppData.outfitSets) {
                if (set.gender && set.gender !== selectedGender) continue;
                const headOk = (set.head == null && selectedClothing.head == null) || (set.head && selectedClothing.head && selectedClothing.head.id === set.head);
                const bodyOk = (set.body == null && selectedClothing.body == null) || (set.body && selectedClothing.body && selectedClothing.body.id === set.body);
                const legsOk = (set.legs == null && selectedClothing.legs == null) || (set.legs && selectedClothing.legs && selectedClothing.legs.id === set.legs);
                const shoesOk = (set.shoes == null && selectedClothing.shoes == null) || (set.shoes && selectedClothing.shoes && selectedClothing.shoes.id === set.shoes);
                if (headOk && bodyOk && legsOk && shoesOk) return set;
            }
            return null;
        }
        
        function getFirstApplicableSetIndex() {
            if (!AppData.outfitSets) return -1;
            for (let i = 0; i < AppData.outfitSets.length; i++) {
                const set = AppData.outfitSets[i];
                if (set.gender && set.gender !== selectedGender) continue;
                const hasHead = !set.head || getClothingItem('head', set.head);
                const hasBody = !set.body || getClothingItem('body', set.body);
                const hasLegs = !set.legs || getClothingItem('legs', set.legs);
                const hasShoes = !set.shoes || getClothingItem('shoes', set.shoes);
                if (hasHead && hasBody && hasLegs && hasShoes) return i;
            }
            return -1;
        }
        
        function getSetIndexForCurrentPreview() {
            if (!AppData.outfitSets || !currentSelectedClothingItem || !currentClothingType) return -1;
            const slot = currentClothingType;
            const itemId = currentSelectedClothingItem.id;
            for (let i = 0; i < AppData.outfitSets.length; i++) {
                const set = AppData.outfitSets[i];
                if (set.gender && set.gender !== selectedGender) continue;
                if (set[slot] !== itemId) continue;
                const hasHead = !set.head || getClothingItem('head', set.head);
                const hasBody = !set.body || getClothingItem('body', set.body);
                const hasLegs = !set.legs || getClothingItem('legs', set.legs);
                const hasShoes = !set.shoes || getClothingItem('shoes', set.shoes);
                if (hasHead && hasBody && hasLegs && hasShoes) return i;
            }
            return -1;
        }
        
        function updateClothingWearSetButton() {
            const btn = document.getElementById('clothing-wear-set-button');
            if (!btn) return;
            const idxPreview = getSetIndexForCurrentPreview();
            const idxAny = getFirstApplicableSetIndex();
            btn.disabled = idxPreview === -1 && idxAny === -1;
            updateClothingSetIcons();
        }
        
        function updateClothingSetIcons() {
            const nameEl = document.getElementById('clothing-set-name');
            const iconsEl = document.getElementById('clothing-set-icons');
            if (!nameEl || !iconsEl) return;
            let idx = getSetIndexForCurrentPreview();
            if (idx === -1) idx = getFirstApplicableSetIndex();
            const set = idx >= 0 && AppData.outfitSets ? AppData.outfitSets[idx] : null;
            const types = ['head', 'body', 'legs', 'shoes'];
            if (!set) {
                nameEl.textContent = 'Соберите комплект';
                types.forEach(slot => {
                    const slotEl = iconsEl.querySelector('.clothing-set-slot[data-slot="' + slot + '"]');
                    if (!slotEl) return;
                    const imgWrap = slotEl.querySelector('.clothing-set-slot-img');
                    if (imgWrap) imgWrap.style.backgroundImage = '';
                    if (imgWrap) imgWrap.innerHTML = '';
                    slotEl.classList.remove('has-item', 'missing-item');
                });
                return;
            }
            nameEl.textContent = set.name || 'Набор';
            types.forEach(slot => {
                const slotEl = iconsEl.querySelector('.clothing-set-slot[data-slot="' + slot + '"]');
                if (!slotEl) return;
                const imgWrap = slotEl.querySelector('.clothing-set-slot-img');
                const itemId = set[slot];
                const item = itemId ? getClothingItem(slot, itemId) : null;
                const hasEquipped = itemId == null
                    ? (selectedClothing[slot] == null)
                    : (selectedClothing[slot] && selectedClothing[slot].id === itemId);
                slotEl.classList.remove('has-item', 'missing-item');
                slotEl.classList.add(hasEquipped ? 'has-item' : 'missing-item');
                if (imgWrap) {
                    imgWrap.innerHTML = '';
                    if (item && item.image) {
                        const img = document.createElement('img');
                        img.src = AppData.repoUrl + item.image;
                        img.alt = item.name;
                        img.onerror = function() { imgWrap.innerHTML = ''; };
                        imgWrap.appendChild(img);
                    }
                }
            });
        }
        
        function wearFullOutfitSet() {
            let idx = getSetIndexForCurrentPreview();
            if (idx === -1) idx = getFirstApplicableSetIndex();
            if (idx === -1) return;
            applyOutfitSet(idx);
            updateClothingWearSetButton();
            closeClothingModal();
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
            }
        }
        
        function updateClothingSetDescription() {
            const btn = document.getElementById('bonus-set-button');
            if (btn) btn.title = getCurrentOutfitSet() ? 'Подробнее о бонусе набора' : 'Соберите комплект — бонус за полный набор';
        }
        
        function refreshClothingSlots() {
            const types = ['head', 'body', 'legs', 'shoes'];
            types.forEach(type => {
                const slot = document.querySelector(`[data-slot-type="${type}"]`);
                if (!slot) return;
                const item = selectedClothing[type];
                if (item) {
                    slot.innerHTML = `<img src="${AppData.repoUrl + item.image}" alt="${item.name}" onerror="this.parentElement.innerHTML='<div class=\'no-image-placeholder\'>Нет изображения</div>'">`;
                } else {
                    slot.innerHTML = `<div class="clothing-slot-icon">${getSlotIcon(type)}</div>`;
                }
            });
        }
        
        function applyOutfitSet(setIndex) {
            if (!AppData.outfitSets || setIndex < 0 || setIndex >= AppData.outfitSets.length) return;
            const set = AppData.outfitSets[setIndex];
            selectedClothing.head = set.head ? getClothingItem('head', set.head) : null;
            selectedClothing.body = set.body ? getClothingItem('body', set.body) : null;
            selectedClothing.legs = set.legs ? getClothingItem('legs', set.legs) : null;
            selectedClothing.shoes = set.shoes ? getClothingItem('shoes', set.shoes) : null;
            refreshClothingSlots();
            updateCharacterImage();
            updateClothingSetDescription();
        }
        
        // Закрытие модального окна при клике вне его
        document.getElementById('clothing-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeClothingModal();
            }
        });
        
        // Функция запуска игры после загрузки
        function startGame() {
            const loaderScreen = document.getElementById('screen-loader');
            const genderScreen = document.getElementById('screen-gender');
            
            if (!loaderScreen || !genderScreen) {
                console.error('Экраны не найдены!');
                return;
            }
            
            loaderScreen.classList.remove('active');
            // Убеждаемся, что экран загрузки не перекрывает другие элементы
            setTimeout(() => {
                loaderScreen.style.display = 'none';
            }, 500);
            
            setTimeout(() => {
                genderScreen.classList.add('active');
                console.log('Экран выбора пола активирован');
            }, 300);
        }
        
        // Устанавливаем фон загрузки сразу при загрузке страницы
        window.addEventListener('DOMContentLoaded', function() {
            // Устанавливаем фоновую заставку сразу
            if (AppData.loaderBackground) {
                const loaderScreen = document.getElementById('screen-loader');
                const bgUrl = AppData.repoUrl + AppData.loaderBackground;
                loaderScreen.style.background = `url('${bgUrl}') center/cover no-repeat, linear-gradient(135deg, #667eea 0%, #764ba2 100%)`;
                
                // Предзагружаем изображение для надежности
                const bgImage = new Image();
                bgImage.src = bgUrl;
            }
            
            // Проверяем, что все кнопки найдены
            if (!buttons.confirmGender) {
                console.error('Кнопка "Далее" не найдена!');
            }
            if (!buttons.male || !buttons.female) {
                console.error('Кнопки выбора пола не найдены!');
            }
            
            // Запускаем предзагрузку всех изображений
            preloadImages();
        });
    </script>
</body>
</html>